#!/bin/bash
# OpenFM (FM) å®Œæ•´å®‰è£…è„šæœ¬ - å¢å¼ºç‰ˆï¼ˆå¸¦å¹¶è¡Œåº”ç”¨åŠŸèƒ½ï¼‰

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# å®‰è£…ç›®å½•
INSTALL_DIR="/opt/openfm"
BIN_DIR="/usr/local/bin"

print_status() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

print_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[i]${NC} $1"
}

print_debug() {
    echo -e "${PURPLE}[d]${NC} $1"
}

print_section() {
    echo -e "${CYAN}â–¶ $1${NC}"
}

# æ£€æŸ¥æƒé™
check_permissions() {
    if [ "$EUID" -eq 0 ]; then
        print_warning "æ­£åœ¨ä»¥rootç”¨æˆ·è¿è¡Œå®‰è£…è„šæœ¬"
    fi
    
    # æ£€æŸ¥æ˜¯å¦æœ‰sudoæƒé™
    if ! sudo -n true 2>/dev/null; then
        print_warning "éœ€è¦sudoæƒé™æ¥åˆ›å»ºç³»ç»Ÿé“¾æ¥"
    fi
}

# æ£€æŸ¥ç³»ç»Ÿä¾èµ–
check_dependencies() {
    print_section "æ£€æŸ¥ç³»ç»Ÿä¾èµ–"
    
    # æ£€æŸ¥Python3
    if ! command -v python3 &> /dev/null; then
        print_error "éœ€è¦ Python3"
        echo "è¯·å®‰è£…:"
        echo "  Ubuntu/Debian: sudo apt install python3"
        echo "  CentOS/RHEL: sudo yum install python3"
        echo "  Arch: sudo pacman -S python"
        exit 1
    fi
    
    # æ£€æŸ¥Pythonç‰ˆæœ¬
    PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
    print_status "Python ç‰ˆæœ¬: $PYTHON_VERSION"
    
    # æ£€æŸ¥tkinterï¼ˆå›¾å½¢ç•Œé¢ç‰ˆéœ€è¦ï¼‰
    if ! python3 -c "import tkinter" 2>/dev/null; then
        print_warning "Python tkinteræ¨¡å—ä¸å¯ç”¨ï¼Œå›¾å½¢ç•Œé¢ç‰ˆå°†æ— æ³•ä½¿ç”¨"
        print_info "å¦‚æœéœ€è¦å›¾å½¢ç•Œé¢ç‰ˆï¼Œè¯·å®‰è£…:"
        print_info "  Ubuntu/Debian: sudo apt install python3-tk"
        print_info "  CentOS/RHEL: sudo yum install python3-tkinter"
        print_info "  Arch: sudo pacman -S tk"
    fi
    
    # æ£€æŸ¥é¢å¤–ä¾èµ–ï¼ˆç”¨äºå¹¶è¡Œåº”ç”¨åŠŸèƒ½ï¼‰
    check_parallel_app_dependencies
    
    print_status "ä¾èµ–æ£€æŸ¥å®Œæˆ"
}

# æ£€æŸ¥å¹¶è¡Œåº”ç”¨åŠŸèƒ½ä¾èµ–
check_parallel_app_dependencies() {
    print_info "æ£€æŸ¥å¹¶è¡Œåº”ç”¨åŠŸèƒ½ä¾èµ–..."
    
    local missing_deps=()
    
    # æ£€æŸ¥ç»ˆç«¯æ¨¡æ‹Ÿå™¨
    if ! command -v xterm &> /dev/null && ! command -v gnome-terminal &> /dev/null && ! command -v konsole &> /dev/null; then
        missing_deps+=("ç»ˆç«¯æ¨¡æ‹Ÿå™¨ (xterm, gnome-terminal, konsole)")
    fi
    
    # æ£€æŸ¥æ–‡æœ¬ç¼–è¾‘å™¨
    if ! command -v gedit &> /dev/null && ! command -v mousepad &> /dev/null && ! command -v kate &> /dev/null; then
        missing_deps+=("æ–‡æœ¬ç¼–è¾‘å™¨ (gedit, mousepad, kate)")
    fi
    
    # æ£€æŸ¥å›¾ç‰‡æŸ¥çœ‹å™¨
    if ! command -v eog &> /dev/null && ! command -v gthumb &> /dev/null && ! command -v feh &> /dev/null; then
        missing_deps+=("å›¾ç‰‡æŸ¥çœ‹å™¨ (eog, gthumb, feh)")
    fi
    
    # æ£€æŸ¥PDFæŸ¥çœ‹å™¨
    if ! command -v evince &> /dev/null && ! command -v okular &> /dev/null && ! command -v xpdf &> /dev/null; then
        missing_deps+=("PDFæŸ¥çœ‹å™¨ (evince, okular, xpdf)")
    fi
    
    # æ£€æŸ¥è§†é¢‘æ’­æ”¾å™¨
    if ! command -v vlc &> /dev/null && ! command -v mpv &> /dev/null && ! command -v mplayer &> /dev/null; then
        missing_deps+=("è§†é¢‘æ’­æ”¾å™¨ (vlc, mpv, mplayer)")
    fi
    
    if [ ${#missing_deps[@]} -gt 0 ]; then
        print_warning "ä»¥ä¸‹ä¾èµ–å¯èƒ½ç¼ºå¤±ï¼ˆå¹¶è¡Œåº”ç”¨åŠŸèƒ½å¯èƒ½å—é™ï¼‰:"
        for dep in "${missing_deps[@]}"; do
            echo "  - $dep"
        done
        echo ""
        echo "å»ºè®®å®‰è£…ï¼ˆUbuntu/Debianï¼‰:"
        echo "  sudo apt install xterm gedit eog evince vlc"
    else
        print_status "å¹¶è¡Œåº”ç”¨åŠŸèƒ½ä¾èµ–æ£€æŸ¥é€šè¿‡"
    fi
}

# æ¸…ç†æ—§ç‰ˆæœ¬
clean_old_version() {
    print_section "æ¸…ç†æ—§ç‰ˆæœ¬"
    
    # åˆ é™¤æ—§çš„mtpanelï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [ -d "/opt/mtpanel" ]; then
        sudo rm -rf "/opt/mtpanel" 2>/dev/null || true
        print_status "å·²åˆ é™¤æ—§ç‰ˆ /opt/mtpanel"
    fi
    
    if [ -f "/usr/local/bin/mtpanel" ]; then
        sudo rm -f "/usr/local/bin/mtpanel" 2>/dev/null || true
        print_status "å·²åˆ é™¤æ—§ç‰ˆ /usr/local/bin/mtpanel"
    fi
    
    # åˆ é™¤æ—§ç‰ˆopenfmï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [ -d "/opt/openfm" ]; then
        print_warning "å‘ç°å·²å­˜åœ¨çš„OpenFMå®‰è£…ï¼Œå°†è¿›è¡Œå‡çº§..."
        sudo rm -rf "/opt/openfm" 2>/dev/null || true
        print_status "å·²æ¸…ç†æ—§ç‰ˆOpenFM"
    fi
}

# åˆ›å»ºç›®å½•ç»“æ„
create_directories() {
    print_section "åˆ›å»ºç›®å½•ç»“æ„"
    
    sudo mkdir -p "$INSTALL_DIR"/{app,data,icons,config,plugins,apps}
    sudo chown -R "$USER:$USER" "$INSTALL_DIR"
    chmod 755 "$INSTALL_DIR"
    
    print_status "ç›®å½•åˆ›å»ºå®Œæˆ: $INSTALL_DIR"
}

# åˆ›å»ºå¹¶è¡Œåº”ç”¨é…ç½®æ–‡ä»¶
create_apps_config() {
    print_info "åˆ›å»ºå¹¶è¡Œåº”ç”¨é…ç½®æ–‡ä»¶..."
    
    cat > "$INSTALL_DIR/config/apps.json" << 'EOF'
{
  "terminal_apps": [
    {
      "name": "ç³»ç»Ÿç»ˆç«¯",
      "command": "x-terminal-emulator",
      "args": [],
      "icon": "terminal",
      "description": "ç³»ç»Ÿé»˜è®¤ç»ˆç«¯"
    },
    {
      "name": "GNOMEç»ˆç«¯",
      "command": "gnome-terminal",
      "args": ["--working-directory={path}"],
      "icon": "gnome-terminal",
      "description": "GNOMEæ¡Œé¢ç»ˆç«¯"
    },
    {
      "name": "Konsole",
      "command": "konsole",
      "args": ["--workdir={path}"],
      "icon": "utilities-terminal",
      "description": "KDEæ¡Œé¢ç»ˆç«¯"
    },
    {
      "name": "XTerm",
      "command": "xterm",
      "args": ["-e", "cd {path} && bash"],
      "icon": "terminal",
      "description": "è½»é‡çº§Xç»ˆç«¯"
    }
  ],
  "text_editors": [
    {
      "name": "GEdit",
      "command": "gedit",
      "args": ["{file}"],
      "icon": "accessories-text-editor",
      "description": "GNOMEæ–‡æœ¬ç¼–è¾‘å™¨"
    },
    {
      "name": "Mousepad",
      "command": "mousepad",
      "args": ["{file}"],
      "icon": "mousepad",
      "description": "Xfceæ–‡æœ¬ç¼–è¾‘å™¨"
    },
    {
      "name": "Kate",
      "command": "kate",
      "args": ["{file}"],
      "icon": "kate",
      "description": "KDEé«˜çº§æ–‡æœ¬ç¼–è¾‘å™¨"
    },
    {
      "name": "VSCode",
      "command": "code",
      "args": ["{file}"],
      "icon": "visual-studio-code",
      "description": "Visual Studio Code"
    }
  ],
  "image_viewers": [
    {
      "name": "Eye of GNOME",
      "command": "eog",
      "args": ["{file}"],
      "icon": "image-viewer",
      "description": "GNOMEå›¾ç‰‡æŸ¥çœ‹å™¨"
    },
    {
      "name": "GThumb",
      "command": "gthumb",
      "args": ["{file}"],
      "icon": "gthumb",
      "description": "é«˜çº§å›¾ç‰‡æŸ¥çœ‹å™¨"
    },
    {
      "name": "Feh",
      "command": "feh",
      "args": ["{file}"],
      "icon": "feh",
      "description": "è½»é‡çº§å›¾ç‰‡æŸ¥çœ‹å™¨"
    }
  ],
  "pdf_viewers": [
    {
      "name": "Evince",
      "command": "evince",
      "args": ["{file}"],
      "icon": "x-office-document",
      "description": "GNOMEæ–‡æ¡£æŸ¥çœ‹å™¨"
    },
    {
      "name": "Okular",
      "command": "okular",
      "args": ["{file}"],
      "icon": "okular",
      "description": "KDEæ–‡æ¡£æŸ¥çœ‹å™¨"
    },
    {
      "name": "XPDF",
      "command": "xpdf",
      "args": ["{file}"],
      "icon": "xpdf",
      "description": "è½»é‡çº§PDFæŸ¥çœ‹å™¨"
    }
  ],
  "video_players": [
    {
      "name": "VLC",
      "command": "vlc",
      "args": ["{file}"],
      "icon": "vlc",
      "description": "VLCåª’ä½“æ’­æ”¾å™¨"
    },
    {
      "name": "MPV",
      "command": "mpv",
      "args": ["{file}"],
      "icon": "mpv",
      "description": "è½»é‡çº§åª’ä½“æ’­æ”¾å™¨"
    },
    {
      "name": "MPlayer",
      "command": "mplayer",
      "args": ["{file}"],
      "icon": "mplayer",
      "description": "ç»å…¸åª’ä½“æ’­æ”¾å™¨"
    }
  ],
  "file_managers": [
    {
      "name": "æ–‡ä»¶ç®¡ç†å™¨",
      "command": "nautilus",
      "args": ["{path}"],
      "icon": "system-file-manager",
      "description": "GNOMEæ–‡ä»¶ç®¡ç†å™¨"
    },
    {
      "name": "Dolphin",
      "command": "dolphin",
      "args": ["{path}"],
      "icon": "dolphin",
      "description": "KDEæ–‡ä»¶ç®¡ç†å™¨"
    },
    {
      "name": "Thunar",
      "command": "thunar",
      "args": ["{path}"],
      "icon": "thunar",
      "description": "Xfceæ–‡ä»¶ç®¡ç†å™¨"
    }
  ],
  "web_browsers": [
    {
      "name": "Firefox",
      "command": "firefox",
      "args": ["{url}"],
      "icon": "firefox",
      "description": "Mozilla Firefox"
    },
    {
      "name": "Chrome",
      "command": "google-chrome",
      "args": ["{url}"],
      "icon": "google-chrome",
      "description": "Google Chrome"
    },
    {
      "name": "Edge",
      "command": "microsoft-edge",
      "args": ["{url}"],
      "icon": "microsoft-edge",
      "description": "Microsoft Edge"
    }
  ],
  "development_tools": [
    {
      "name": "Pythonäº¤äº’å¼",
      "command": "python3",
      "args": ["-i", "{file}"],
      "icon": "python",
      "description": "Pythonäº¤äº’å¼ç¯å¢ƒ"
    },
    {
      "name": "Node.js REPL",
      "command": "node",
      "args": [],
      "icon": "nodejs",
      "description": "Node.js REPLç¯å¢ƒ"
    },
    {
      "name": "Bash Shell",
      "command": "bash",
      "args": [],
      "icon": "bash",
      "description": "Bash Shell"
    }
  ]
}
EOF
    
    print_status "å¹¶è¡Œåº”ç”¨é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºå¢å¼ºç‰ˆå›¾å½¢ç•Œé¢ä¸»ç¨‹åº
create_enhanced_gui_version() {
    print_section "åˆ›å»ºå¢å¼ºç‰ˆå›¾å½¢ç•Œé¢"
    
    cat > "$INSTALL_DIR/app/fm_enhanced.py" << 'EOF'
#!/usr/bin/env python3
"""
OpenFM (FM) - å¢å¼ºç‰ˆå›¾å½¢ç•Œé¢
å¸¦å¹¶è¡Œåº”ç”¨åŠŸèƒ½çš„åŒé¢æ¿æ–‡ä»¶ç®¡ç†å™¨
"""

import os
import sys
import json
import shutil
import tkinter as tk
from tkinter import ttk, messagebox, filedialog, simpledialog, Menu
import getpass
import stat
import pwd
import grp
from datetime import datetime
import subprocess
import threading
import time
import signal
from pathlib import Path
import tempfile

class OpenFMEnhanced:
    """OpenFM å¢å¼ºç‰ˆä¸»ç±» - å¸¦å¹¶è¡Œåº”ç”¨åŠŸèƒ½"""
    VERSION = "2.0.0-Enhanced"
    
    def __init__(self, root):
        self.root = root
        self.root.title(f"OpenFM v{self.VERSION}")
        
        # ç”¨æˆ·ä¿¡æ¯
        self.username = getpass.getuser()
        self.hostname = os.uname().nodename
        
        # è®¾ç½®çª—å£å¤§å°
        screen_width = root.winfo_screenwidth()
        screen_height = root.winfo_screenheight()
        window_width = min(1400, screen_width - 100)
        window_height = min(900, screen_height - 100)
        
        x = (screen_width - window_width) // 2
        y = (screen_height - window_height) // 2
        
        self.root.geometry(f"{window_width}x{window_height}+{x}+{y}")
        self.root.minsize(1000, 700)
        
        # å¹¶è¡Œåº”ç”¨çŠ¶æ€
        self.left_app_process = None
        self.right_app_process = None
        self.left_app_frame = None
        self.right_app_frame = None
        self.left_app_mode = "file_manager"  # file_manager, terminal, editor, viewer
        self.right_app_mode = "file_manager"
        self.left_app_config = None
        self.right_app_config = None
        
        # é¢æ¿è®¾ç½®
        self.left_panel_path = os.path.expanduser("~")
        self.right_panel_path = "/tmp"
        self.active_panel = "left"
        
        # åŠ è½½åº”ç”¨é…ç½®
        self.load_app_config()
        
        # åˆå§‹åŒ–ç•Œé¢
        self.setup_ui()
        
        # åŠ è½½åˆå§‹ç›®å½•
        self.load_panel("left")
        self.load_panel("right")
        
        # ç»‘å®šå¿«æ·é”®
        self.bind_shortcuts()
        
        # æ›´æ–°çŠ¶æ€æ 
        self.update_status()
        
        # çª—å£å…³é—­äº‹ä»¶
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)
    
    def load_app_config(self):
        """åŠ è½½åº”ç”¨é…ç½®æ–‡ä»¶"""
        config_path = "/opt/openfm/config/apps.json"
        try:
            with open(config_path, 'r', encoding='utf-8') as f:
                self.app_config = json.load(f)
        except:
            # é»˜è®¤é…ç½®
            self.app_config = {
                "terminal_apps": [
                    {
                        "name": "ç³»ç»Ÿç»ˆç«¯",
                        "command": "x-terminal-emulator",
                        "args": [],
                        "icon": "terminal",
                        "description": "ç³»ç»Ÿé»˜è®¤ç»ˆç«¯"
                    }
                ],
                "text_editors": [
                    {
                        "name": "æ–‡æœ¬ç¼–è¾‘å™¨",
                        "command": "gedit",
                        "args": ["{file}"],
                        "icon": "accessories-text-editor",
                        "description": "æ–‡æœ¬ç¼–è¾‘å™¨"
                    }
                ],
                "file_managers": [
                    {
                        "name": "æ–‡ä»¶ç®¡ç†å™¨",
                        "command": "nautilus",
                        "args": ["{path}"],
                        "icon": "system-file-manager",
                        "description": "æ–‡ä»¶ç®¡ç†å™¨"
                    }
                ]
            }
    
    def setup_ui(self):
        """è®¾ç½®å¢å¼ºç‰ˆç”¨æˆ·ç•Œé¢"""
        # åˆ›å»ºä¸»æ¡†æ¶
        main_frame = ttk.Frame(self.root)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        
        # é¡¶éƒ¨èœå•æ 
        self.create_menu_bar(main_frame)
        
        # é¡¶éƒ¨å·¥å…·æ 
        self.create_enhanced_toolbar(main_frame)
        
        # å¹¶è¡Œåº”ç”¨åŒºåŸŸ
        self.create_parallel_apps_area(main_frame)
        
        # çŠ¶æ€æ 
        self.create_statusbar(main_frame)
        
        # å³é”®èœå•
        self.create_context_menu()
    
    def create_menu_bar(self, parent):
        """åˆ›å»ºèœå•æ """
        menubar = tk.Menu(self.root)
        self.root.config(menu=menubar)
        
        # æ–‡ä»¶èœå•
        file_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="æ–‡ä»¶", menu=file_menu)
        file_menu.add_command(label="æ–°å»ºæ–‡ä»¶", command=self.create_file)
        file_menu.add_command(label="æ–°å»ºæ–‡ä»¶å¤¹", command=self.create_folder)
        file_menu.add_separator()
        file_menu.add_command(label="é€€å‡º", command=self.root.quit)
        
        # è§†å›¾èœå•
        view_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="è§†å›¾", menu=view_menu)
        
        # å·¦é¢æ¿åº”ç”¨å­èœå•
        left_app_menu = tk.Menu(view_menu, tearoff=0)
        view_menu.add_cascade(label="å·¦é¢æ¿åº”ç”¨", menu=left_app_menu)
        left_app_menu.add_command(label="æ–‡ä»¶ç®¡ç†å™¨", command=lambda: self.switch_app_mode("left", "file_manager"))
        left_app_menu.add_command(label="ç»ˆç«¯", command=lambda: self.switch_app_mode("left", "terminal"))
        left_app_menu.add_command(label="æ–‡æœ¬ç¼–è¾‘å™¨", command=lambda: self.switch_app_mode("left", "editor"))
        left_app_menu.add_command(label="å›¾ç‰‡æŸ¥çœ‹å™¨", command=lambda: self.switch_app_mode("left", "image_viewer"))
        left_app_menu.add_command(label="PDFæŸ¥çœ‹å™¨", command=lambda: self.switch_app_mode("left", "pdf_viewer"))
        left_app_menu.add_command(label="åª’ä½“æ’­æ”¾å™¨", command=lambda: self.switch_app_mode("left", "video_player"))
        left_app_menu.add_command(label="ç½‘é¡µæµè§ˆå™¨", command=lambda: self.switch_app_mode("left", "web_browser"))
        
        # å³é¢æ¿åº”ç”¨å­èœå•
        right_app_menu = tk.Menu(view_menu, tearoff=0)
        view_menu.add_cascade(label="å³é¢æ¿åº”ç”¨", menu=right_app_menu)
        right_app_menu.add_command(label="æ–‡ä»¶ç®¡ç†å™¨", command=lambda: self.switch_app_mode("right", "file_manager"))
        right_app_menu.add_command(label="ç»ˆç«¯", command=lambda: self.switch_app_mode("right", "terminal"))
        right_app_menu.add_command(label="æ–‡æœ¬ç¼–è¾‘å™¨", command=lambda: self.switch_app_mode("right", "editor"))
        right_app_menu.add_command(label="å›¾ç‰‡æŸ¥çœ‹å™¨", command=lambda: self.switch_app_mode("right", "image_viewer"))
        right_app_menu.add_command(label="PDFæŸ¥çœ‹å™¨", command=lambda: self.switch_app_mode("right", "pdf_viewer"))
        right_app_menu.add_command(label="åª’ä½“æ’­æ”¾å™¨", command=lambda: self.switch_app_mode("right", "video_player"))
        right_app_menu.add_command(label="ç½‘é¡µæµè§ˆå™¨", command=lambda: self.switch_app_mode("right", "web_browser"))
        
        view_menu.add_separator()
        view_menu.add_command(label="åˆ·æ–°", command=self.refresh_panels)
        view_menu.add_command(label="å…¨å±", command=self.toggle_fullscreen)
        
        # å·¥å…·èœå•
        tools_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="å·¥å…·", menu=tools_menu)
        tools_menu.add_command(label="æ‰¹é‡é‡å‘½å", command=self.batch_rename)
        tools_menu.add_command(label="æŸ¥æ‰¾æ–‡ä»¶", command=self.find_files)
        tools_menu.add_command(label="è®¡ç®—å¤§å°", command=self.calculate_size)
        tools_menu.add_separator()
        tools_menu.add_command(label="è®¾ç½®", command=self.show_settings)
        
        # å¸®åŠ©èœå•
        help_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="å¸®åŠ©", menu=help_menu)
        help_menu.add_command(label="ç”¨æˆ·æ‰‹å†Œ", command=self.show_manual)
        help_menu.add_command(label="å¿«æ·é”®", command=self.show_shortcuts)
        help_menu.add_separator()
        help_menu.add_command(label="å…³äº", command=self.show_about)
    
    def create_enhanced_toolbar(self, parent):
        """åˆ›å»ºå¢å¼ºç‰ˆå·¥å…·æ """
        toolbar = ttk.Frame(parent)
        toolbar.pack(fill=tk.X, pady=(0, 5))
        
        # æ±‰å ¡èœå•æŒ‰é’®ï¼ˆä¸‰æ¡æ¨ªæ ï¼‰
        hamburger_btn = ttk.Button(toolbar, text="â˜°", width=2, command=self.show_app_selector)
        hamburger_btn.pack(side=tk.LEFT, padx=2)
        self.create_tooltip(hamburger_btn, "åº”ç”¨é€‰æ‹©å™¨")
        
        # åˆ†éš”ç¬¦
        ttk.Separator(toolbar, orient=tk.VERTICAL).pack(side=tk.LEFT, padx=5, fill=tk.Y)
        
        # åº”ç”¨æ¨¡å¼åˆ‡æ¢æŒ‰é’®
        app_modes = [
            ("ğŸ“", "file_manager", "æ–‡ä»¶ç®¡ç†å™¨"),
            ("âŒ¨ï¸", "terminal", "ç»ˆç«¯"),
            ("ğŸ“", "editor", "æ–‡æœ¬ç¼–è¾‘å™¨"),
            ("ğŸ–¼ï¸", "image_viewer", "å›¾ç‰‡æŸ¥çœ‹å™¨"),
            ("ğŸ“„", "pdf_viewer", "PDFæŸ¥çœ‹å™¨"),
            ("ğŸ¬", "video_player", "åª’ä½“æ’­æ”¾å™¨"),
            ("ğŸŒ", "web_browser", "ç½‘é¡µæµè§ˆå™¨")
        ]
        
        for text, mode, tooltip in app_modes:
            btn = ttk.Button(toolbar, text=text, width=2, 
                           command=lambda m=mode: self.quick_switch_app(m))
            btn.pack(side=tk.LEFT, padx=1)
            self.create_tooltip(btn, tooltip)
        
        # åˆ†éš”ç¬¦
        ttk.Separator(toolbar, orient=tk.VERTICAL).pack(side=tk.LEFT, padx=5, fill=tk.Y)
        
        # æ–‡ä»¶æ“ä½œæŒ‰é’®
        file_buttons = [
            ("â†»", self.refresh_panels, "åˆ·æ–°"),
            ("â†’", self.copy_to_right, "å¤åˆ¶åˆ°å³ä¾§"),
            ("â†", self.copy_to_left, "å¤åˆ¶åˆ°å·¦ä¾§"),
            ("âœ", self.rename_item, "é‡å‘½å"),
            ("ğŸ—‘", self.delete_item, "åˆ é™¤"),
            ("ğŸ”’", self.change_permissions, "æƒé™"),
            ("â„¹", self.show_explanation, "ä¿¡æ¯")
        ]
        
        for text, command, tooltip in file_buttons:
            btn = ttk.Button(toolbar, text=text, width=2, command=command)
            btn.pack(side=tk.LEFT, padx=1)
            self.create_tooltip(btn, tooltip)
        
        # åˆ†éš”ç¬¦
        ttk.Separator(toolbar, orient=tk.VERTICAL).pack(side=tk.LEFT, padx=5, fill=tk.Y)
        
        # è·¯å¾„è¾“å…¥æ¡†
        self.path_var = tk.StringVar()
        self.path_entry = ttk.Entry(toolbar, textvariable=self.path_var, width=60)
        self.path_entry.pack(side=tk.LEFT, padx=5, fill=tk.X, expand=True)
        self.path_entry.bind("<Return>", self.on_path_changed)
        
        # å¿«é€Ÿè®¿é—®æŒ‰é’®
        quick_access = [
            ("ğŸ ", os.path.expanduser("~"), "ä¸»ç›®å½•"),
            ("ğŸ“‚", "/tmp", "ä¸´æ—¶ç›®å½•"),
            ("â¬‡ï¸", os.path.expanduser("~/Downloads"), "ä¸‹è½½ç›®å½•"),
            ("ğŸ“·", os.path.expanduser("~/Pictures"), "å›¾ç‰‡ç›®å½•")
        ]
        
        for text, path, tooltip in quick_access:
            btn = ttk.Button(toolbar, text=text, width=2,
                           command=lambda p=path: self.quick_navigate(p))
            btn.pack(side=tk.RIGHT, padx=1)
            self.create_tooltip(btn, tooltip)
    
    def create_parallel_apps_area(self, parent):
        """åˆ›å»ºå¹¶è¡Œåº”ç”¨åŒºåŸŸ"""
        apps_frame = ttk.Frame(parent)
        apps_frame.pack(fill=tk.BOTH, expand=True)
        
        # å·¦åº”ç”¨åŒºåŸŸ
        self.left_app_container = ttk.LabelFrame(apps_frame, text="å·¦é¢æ¿")
        self.left_app_container.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 2))
        
        # å·¦åº”ç”¨æ§åˆ¶æ 
        left_control = ttk.Frame(self.left_app_container)
        left_control.pack(fill=tk.X, padx=5, pady=5)
        
        self.left_app_label = ttk.Label(left_control, text="æ–‡ä»¶ç®¡ç†å™¨")
        self.left_app_label.pack(side=tk.LEFT)
        
        self.left_app_btn = ttk.Button(left_control, text="åˆ‡æ¢åº”ç”¨", width=10,
                                      command=lambda: self.show_app_selector_for_panel("left"))
        self.left_app_btn.pack(side=tk.RIGHT)
        
        # å·¦åº”ç”¨å†…å®¹åŒºåŸŸ
        self.left_content_frame = ttk.Frame(self.left_app_container)
        self.left_content_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=(0, 5))
        
        # åˆå§‹åŒ–å·¦é¢æ¿ä¸ºæ–‡ä»¶ç®¡ç†å™¨
        self.init_file_manager_panel("left")
        
        # å³åº”ç”¨åŒºåŸŸ
        self.right_app_container = ttk.LabelFrame(apps_frame, text="å³é¢æ¿")
        self.right_app_container.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(2, 0))
        
        # å³åº”ç”¨æ§åˆ¶æ 
        right_control = ttk.Frame(self.right_app_container)
        right_control.pack(fill=tk.X, padx=5, pady=5)
        
        self.right_app_label = ttk.Label(right_control, text="æ–‡ä»¶ç®¡ç†å™¨")
        self.right_app_label.pack(side=tk.LEFT)
        
        self.right_app_btn = ttk.Button(right_control, text="åˆ‡æ¢åº”ç”¨", width=10,
                                       command=lambda: self.show_app_selector_for_panel("right"))
        self.right_app_btn.pack(side=tk.RIGHT)
        
        # å³åº”ç”¨å†…å®¹åŒºåŸŸ
        self.right_content_frame = ttk.Frame(self.right_app_container)
        self.right_content_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=(0, 5))
        
        # åˆå§‹åŒ–å³é¢æ¿ä¸ºæ–‡ä»¶ç®¡ç†å™¨
        self.init_file_manager_panel("right")
        
        # ä¸­é—´åˆ†éš”æ¡
        separator = ttk.Frame(apps_frame, width=8, style="Separator.TFrame")
        separator.pack(side=tk.LEFT, fill=tk.Y)
        separator.bind("<Button-1>", self.on_separator_drag_start)
        separator.bind("<B1-Motion>", self.on_separator_drag)
        
        # è®¾ç½®åˆ†éš”æ¡æ ·å¼
        style = ttk.Style()
        style.configure("Separator.TFrame", background="gray")
    
    def init_file_manager_panel(self, panel_name):
        """åˆå§‹åŒ–æ–‡ä»¶ç®¡ç†å™¨é¢æ¿"""
        if panel_name == "left":
            frame = self.left_content_frame
            path = self.left_panel_path
        else:
            frame = self.right_content_frame
            path = self.right_panel_path
        
        # æ¸…ç©ºå†…å®¹
        for widget in frame.winfo_children():
            widget.destroy()
        
        # åˆ›å»ºæ–‡ä»¶ç®¡ç†å™¨ç•Œé¢
        self.create_file_manager_ui(frame, panel_name, path)
    
    def create_file_manager_ui(self, parent, panel_name, initial_path):
        """åˆ›å»ºæ–‡ä»¶ç®¡ç†å™¨ç•Œé¢"""
        # è·¯å¾„æ ‡ç­¾
        path_label = ttk.Label(parent, text=initial_path, relief=tk.SUNKEN)
        path_label.pack(fill=tk.X, padx=5, pady=5)
        
        # ä¿å­˜è·¯å¾„æ ‡ç­¾å¼•ç”¨
        if panel_name == "left":
            self.left_path_label = path_label
        else:
            self.right_path_label = path_label
        
        # åˆ›å»ºæ ‘è§†å›¾
        tree = ttk.Treeview(parent, columns=("type", "size", "permission", "owner"), show="tree headings")
        
        # è®¾ç½®åˆ—
        tree.heading("#0", text="åç§°")
        tree.heading("type", text="ç±»å‹")
        tree.heading("size", text="å¤§å°")
        tree.heading("permission", text="æƒé™")
        tree.heading("owner", text="æ‰€æœ‰è€…")
        
        tree.column("#0", width=250, stretch=True)
        tree.column("type", width=80, anchor="center")
        tree.column("size", width=80, anchor="e")
        tree.column("permission", width=100, anchor="center")
        tree.column("owner", width=100, anchor="center")
        
        # ç»‘å®šäº‹ä»¶
        tree.bind("<Double-Button-1>", lambda e: self.on_item_double_click(panel_name))
        tree.bind("<ButtonRelease-1>", lambda e: self.on_item_click(panel_name))
        tree.bind("<Button-3>", lambda e: self.show_context_menu(e, panel_name))
        
        # ä¿å­˜æ ‘è§†å›¾å¼•ç”¨
        if panel_name == "left":
            self.left_tree = tree
        else:
            self.right_tree = tree
        
        # æ»šåŠ¨æ¡
        scrollbar = ttk.Scrollbar(parent, orient=tk.VERTICAL, command=tree.yview)
        tree.configure(yscrollcommand=scrollbar.set)
        
        # æ‰“åŒ…
        tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
    
    def create_tooltip(self, widget, text):
        """åˆ›å»ºå·¥å…·æç¤º"""
        def show_tooltip(event):
            tooltip_window = tk.Toplevel(widget)
            tooltip_window.wm_overrideredirect(True)
            tooltip_window.wm_geometry(f"+{event.x_root+10}+{event.y_root+10}")
            label = tk.Label(tooltip_window, text=text, bg="lightyellow", 
                           relief=tk.SOLID, borderwidth=1, padx=5, pady=2)
            label.pack()
            tooltip_window.after(2000, tooltip_window.destroy)
        
        widget.bind("<Enter>", show_tooltip)
    
    def show_app_selector(self):
        """æ˜¾ç¤ºåº”ç”¨é€‰æ‹©å™¨ï¼ˆæ±‰å ¡èœå•ï¼‰"""
        selector_window = tk.Toplevel(self.root)
        selector_window.title("é€‰æ‹©åº”ç”¨")
        selector_window.geometry("600x500")
        selector_window.transient(self.root)
        selector_window.grab_set()
        
        # åˆ›å»ºç¬”è®°æœ¬å¼é€‰é¡¹å¡
        notebook = ttk.Notebook(selector_window)
        notebook.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # å·¦é¢æ¿åº”ç”¨é€‰æ‹©
        left_frame = ttk.Frame(notebook)
        notebook.add(left_frame, text="å·¦é¢æ¿åº”ç”¨")
        
        left_label = ttk.Label(left_frame, text="é€‰æ‹©å·¦é¢æ¿åº”ç”¨:", font=("Arial", 12, "bold"))
        left_label.pack(pady=10)
        
        left_apps_frame = ttk.Frame(left_frame)
        left_apps_frame.pack(fill=tk.BOTH, expand=True, padx=20)
        
        # åˆ›å»ºå·¦é¢æ¿åº”ç”¨æŒ‰é’®
        self.create_app_buttons(left_apps_frame, "left")
        
        # å³é¢æ¿åº”ç”¨é€‰æ‹©
        right_frame = ttk.Frame(notebook)
        notebook.add(right_frame, text="å³é¢æ¿åº”ç”¨")
        
        right_label = ttk.Label(right_frame, text="é€‰æ‹©å³é¢æ¿åº”ç”¨:", font=("Arial", 12, "bold"))
        right_label.pack(pady=10)
        
        right_apps_frame = ttk.Frame(right_frame)
        right_apps_frame.pack(fill=tk.BOTH, expand=True, padx=20)
        
        # åˆ›å»ºå³é¢æ¿åº”ç”¨æŒ‰é’®
        self.create_app_buttons(right_apps_frame, "right")
        
        # å¹¶è¡Œåº”ç”¨é…ç½®
        config_frame = ttk.Frame(notebook)
        notebook.add(config_frame, text="é…ç½®")
        
        ttk.Label(config_frame, text="å¹¶è¡Œåº”ç”¨é…ç½®", font=("Arial", 12, "bold")).pack(pady=10)
        
        # æ·»åŠ é…ç½®é€‰é¡¹
        config_options = [
            ("è‡ªåŠ¨ä¿å­˜åº”ç”¨çŠ¶æ€", tk.BooleanVar(value=True)),
            ("è®°ä½æœ€åä½¿ç”¨çš„åº”ç”¨", tk.BooleanVar(value=True)),
            ("åº”ç”¨åˆ‡æ¢ç¡®è®¤", tk.BooleanVar(value=False))
        ]
        
        for text, var in config_options:
            cb = ttk.Checkbutton(config_frame, text=text, variable=var)
            cb.pack(anchor=tk.W, padx=20, pady=5)
        
        # å…³é—­æŒ‰é’®
        close_btn = ttk.Button(selector_window, text="å…³é—­", command=selector_window.destroy)
        close_btn.pack(pady=10)
    
    def show_app_selector_for_panel(self, panel_name):
        """æ˜¾ç¤ºæŒ‡å®šé¢æ¿çš„åº”ç”¨é€‰æ‹©å™¨"""
        selector_window = tk.Toplevel(self.root)
        selector_window.title(f"é€‰æ‹©{panel_name}é¢æ¿åº”ç”¨")
        selector_window.geometry("500x400")
        selector_window.transient(self.root)
        selector_window.grab_set()
        
        label = ttk.Label(selector_window, text=f"é€‰æ‹©{panel_name}é¢æ¿åº”ç”¨:", 
                         font=("Arial", 12, "bold"))
        label.pack(pady=20)
        
        apps_frame = ttk.Frame(selector_window)
        apps_frame.pack(fill=tk.BOTH, expand=True, padx=20)
        
        self.create_app_buttons(apps_frame, panel_name)
        
        close_btn = ttk.Button(selector_window, text="å…³é—­", 
                              command=selector_window.destroy)
        close_btn.pack(pady=10)
    
    def create_app_buttons(self, parent, panel_name):
        """åˆ›å»ºåº”ç”¨é€‰æ‹©æŒ‰é’®"""
        # åº”ç”¨ç±»åˆ«
        app_categories = [
            ("æ–‡ä»¶ç®¡ç†å™¨", "file_manager", "ğŸ“", self.app_config.get("file_managers", [])),
            ("ç»ˆç«¯", "terminal", "âŒ¨ï¸", self.app_config.get("terminal_apps", [])),
            ("æ–‡æœ¬ç¼–è¾‘å™¨", "editor", "ğŸ“", self.app_config.get("text_editors", [])),
            ("å›¾ç‰‡æŸ¥çœ‹å™¨", "image_viewer", "ğŸ–¼ï¸", self.app_config.get("image_viewers", [])),
            ("PDFæŸ¥çœ‹å™¨", "pdf_viewer", "ğŸ“„", self.app_config.get("pdf_viewers", [])),
            ("åª’ä½“æ’­æ”¾å™¨", "video_player", "ğŸ¬", self.app_config.get("video_players", [])),
            ("ç½‘é¡µæµè§ˆå™¨", "web_browser", "ğŸŒ", self.app_config.get("web_browsers", [])),
            ("å¼€å‘å·¥å…·", "dev_tools", "ğŸ’»", self.app_config.get("development_tools", []))
        ]
        
        # åˆ›å»ºæ»šåŠ¨åŒºåŸŸ
        canvas = tk.Canvas(parent)
        scrollbar = ttk.Scrollbar(parent, orient=tk.VERTICAL, command=canvas.yview)
        scrollable_frame = ttk.Frame(canvas)
        
        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )
        
        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)
        
        for category_name, category_key, icon, apps in app_categories:
            if apps:  # åªæ˜¾ç¤ºæœ‰åº”ç”¨çš„ç±»åˆ«
                # ç±»åˆ«æ ‡é¢˜
                category_frame = ttk.LabelFrame(scrollable_frame, text=f"{icon} {category_name}")
                category_frame.pack(fill=tk.X, padx=5, pady=5, ipadx=5, ipady=5)
                
                # åº”ç”¨æŒ‰é’®
                for app in apps:
                    btn_text = f"{app.get('name', 'Unknown')}\n{app.get('description', '')}"
                    btn = ttk.Button(category_frame, text=btn_text,
                                   command=lambda p=panel_name, c=category_key, a=app: 
                                   self.select_app_for_panel(p, c, a))
                    btn.pack(fill=tk.X, padx=10, pady=2)
        
        canvas.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
    
    def select_app_for_panel(self, panel_name, category_key, app_config):
        """ä¸ºæŒ‡å®šé¢æ¿é€‰æ‹©åº”ç”¨"""
        if panel_name == "left":
            self.left_app_mode = category_key
            self.left_app_config = app_config
            self.left_app_label.config(text=app_config.get("name", "Unknown"))
            self.switch_app(panel_name, category_key, app_config)
        else:
            self.right_app_mode = category_key
            self.right_app_config = app_config
            self.right_app_label.config(text=app_config.get("name", "Unknown"))
            self.switch_app(panel_name, category_key, app_config)
    
    def switch_app(self, panel_name, category_key, app_config):
        """åˆ‡æ¢åˆ°æŒ‡å®šåº”ç”¨"""
        # åœæ­¢å½“å‰åº”ç”¨è¿›ç¨‹
        if panel_name == "left" and self.left_app_process:
            try:
                self.left_app_process.terminate()
                self.left_app_process.wait(timeout=2)
            except:
                pass
            self.left_app_process = None
        
        if panel_name == "right" and self.right_app_process:
            try:
                self.right_app_process.terminate()
                self.right_app_process.wait(timeout=2)
            except:
                pass
            self.right_app_process = None
        
        # æ¸…ç©ºå†…å®¹åŒºåŸŸ
        if panel_name == "left":
            content_frame = self.left_content_frame
            current_path = self.left_panel_path
        else:
            content_frame = self.right_content_frame
            current_path = self.right_panel_path
        
        for widget in content_frame.winfo_children():
            widget.destroy()
        
        # æ ¹æ®åº”ç”¨ç±»å‹åŠ è½½ä¸åŒçš„ç•Œé¢
        if category_key == "file_manager":
            self.create_file_manager_ui(content_frame, panel_name, current_path)
            self.load_panel(panel_name)
        
        elif category_key == "terminal":
            self.start_terminal_app(content_frame, panel_name, app_config, current_path)
        
        elif category_key in ["editor", "image_viewer", "pdf_viewer", "video_player"]:
            self.start_viewer_app(content_frame, panel_name, app_config, current_path)
        
        elif category_key == "web_browser":
            self.start_browser_app(content_frame, panel_name, app_config)
        
        elif category_key == "dev_tools":
            self.start_dev_tool(content_frame, panel_name, app_config, current_path)
    
    def start_terminal_app(self, parent, panel_name, app_config, current_path):
        """å¯åŠ¨ç»ˆç«¯åº”ç”¨"""
        try:
            command = app_config.get("command", "x-terminal-emulator")
            args = app_config.get("args", [])
            
            # æ›¿æ¢è·¯å¾„å‚æ•°
            processed_args = []
            for arg in args:
                if "{path}" in arg:
                    arg = arg.replace("{path}", current_path)
                processed_args.append(arg)
            
            # åˆ›å»ºç»ˆç«¯æ¡†æ¶
            terminal_frame = ttk.Frame(parent)
            terminal_frame.pack(fill=tk.BOTH, expand=True)
            
            # æ·»åŠ ç»ˆç«¯æ§åˆ¶æŒ‰é’®
            control_frame = ttk.Frame(terminal_frame)
            control_frame.pack(fill=tk.X, padx=5, pady=5)
            
            ttk.Label(control_frame, text=f"ç»ˆç«¯: {app_config.get('name', 'Unknown')}").pack(side=tk.LEFT)
            
            # ç³»ç»Ÿç»ˆç«¯æŒ‰é’®
            sys_term_btn = ttk.Button(control_frame, text="è°ƒç”¨ç³»ç»Ÿç»ˆç«¯",
                                     command=lambda: self.launch_system_terminal(current_path))
            sys_term_btn.pack(side=tk.RIGHT)
            
            # ç»ˆç«¯æ¨¡æ‹ŸåŒºåŸŸ
            term_display = tk.Text(terminal_frame, wrap=tk.WORD, bg="black", fg="white",
                                 font=("Monospace", 10))
            scrollbar = ttk.Scrollbar(terminal_frame, orient=tk.VERTICAL, command=term_display.yview)
            term_display.configure(yscrollcommand=scrollbar.set)
            
            term_display.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
            
            # æ·»åŠ æç¤ºä¿¡æ¯
            term_display.insert(tk.END, f"æ­£åœ¨å¯åŠ¨ç»ˆç«¯: {command}\n")
            term_display.insert(tk.END, f"å·¥ä½œç›®å½•: {current_path}\n")
            term_display.insert(tk.END, "-" * 50 + "\n")
            term_display.insert(tk.END, "æç¤º: è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„ç»ˆç«¯ç•Œé¢\n")
            term_display.insert(tk.END, "ç‚¹å‡»'è°ƒç”¨ç³»ç»Ÿç»ˆç«¯'æŒ‰é’®æ‰“å¼€çœŸæ­£çš„ç»ˆç«¯\n\n")
            
            # æ·»åŠ ç®€å•çš„äº¤äº’
            term_display.insert(tk.END, "$ ")
            term_display.mark_set("input", tk.END)
            term_display.focus_set()
            
            def on_terminal_key(event):
                if event.keysym == "Return":
                    # è·å–è¾“å…¥
                    input_start = term_display.search("$ ", "input-1c", backwards=True)
                    if input_start:
                        cmd = term_display.get(input_start + " +2c", "input")
                        self.execute_terminal_command(cmd, term_display)
                        term_display.insert(tk.END, "\n$ ")
                        term_display.mark_set("input", tk.END)
                        term_display.see(tk.END)
                    return "break"
                return None
            
            term_display.bind("<Key>", on_terminal_key)
            
            # å¦‚æœæ˜¯çœŸæ­£çš„ç»ˆç«¯åº”ç”¨ï¼Œå¯åŠ¨å¤–éƒ¨è¿›ç¨‹
            if command != "embedded":
                try:
                    if panel_name == "left":
                        self.left_app_process = subprocess.Popen(
                            [command] + processed_args,
                            cwd=current_path
                        )
                    else:
                        self.right_app_process = subprocess.Popen(
                            [command] + processed_args,
                            cwd=current_path
                        )
                except Exception as e:
                    term_display.insert(tk.END, f"å¯åŠ¨å¤±è´¥: {str(e)}\n")
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯åŠ¨ç»ˆç«¯å¤±è´¥: {str(e)}")
    
    def execute_terminal_command(self, command, text_widget):
        """æ‰§è¡Œç»ˆç«¯å‘½ä»¤"""
        command = command.strip()
        
        if command == "":
            return
        
        text_widget.insert(tk.END, f"æ‰§è¡Œ: {command}\n")
        
        # å†…ç½®å‘½ä»¤
        if command == "help":
            text_widget.insert(tk.END, "å¯ç”¨å‘½ä»¤:\n")
            text_widget.insert(tk.END, "  help      - æ˜¾ç¤ºå¸®åŠ©\n")
            text_widget.insert(tk.END, "  clear     - æ¸…å±\n")
            text_widget.insert(tk.END, "  pwd       - æ˜¾ç¤ºå½“å‰ç›®å½•\n")
            text_widget.insert(tk.END, "  ls        - åˆ—å‡ºæ–‡ä»¶\n")
            text_widget.insert(tk.END, "  date      - æ˜¾ç¤ºæ—¥æœŸæ—¶é—´\n")
            text_widget.insert(tk.END, "  sysinfo   - ç³»ç»Ÿä¿¡æ¯\n")
            text_widget.insert(tk.END, "  å…¶ä»–å‘½ä»¤å°†åœ¨ç³»ç»Ÿç»ˆç«¯ä¸­æ‰§è¡Œ\n")
        
        elif command == "clear":
            text_widget.delete("1.0", tk.END)
            text_widget.insert(tk.END, "$ ")
        
        elif command == "pwd":
            text_widget.insert(tk.END, os.getcwd() + "\n")
        
        elif command == "ls":
            try:
                files = os.listdir(".")
                for f in files:
                    if os.path.isdir(f):
                        text_widget.insert(tk.END, f"{f}/\n")
                    else:
                        text_widget.insert(tk.END, f"{f}\n")
            except Exception as e:
                text_widget.insert(tk.END, f"é”™è¯¯: {str(e)}\n")
        
        elif command == "date":
            text_widget.insert(tk.END, datetime.now().strftime("%Y-%m-%d %H:%M:%S") + "\n")
        
        elif command == "sysinfo":
            import platform
            text_widget.insert(tk.END, f"ç³»ç»Ÿ: {platform.system()} {platform.release()}\n")
            text_widget.insert(tk.END, f"å¤„ç†å™¨: {platform.processor()}\n")
            text_widget.insert(tk.END, f"Pythonç‰ˆæœ¬: {platform.python_version()}\n")
        
        else:
            text_widget.insert(tk.END, f"å°†åœ¨ç³»ç»Ÿç»ˆç«¯ä¸­æ‰§è¡Œ: {command}\n")
            text_widget.insert(tk.END, "ç‚¹å‡»'è°ƒç”¨ç³»ç»Ÿç»ˆç«¯'æŒ‰é’®æ‰“å¼€ç»ˆç«¯\n")
    
    def launch_system_terminal(self, path=None):
        """å¯åŠ¨ç³»ç»Ÿç»ˆç«¯"""
        try:
            # å°è¯•ä¸åŒçš„ç»ˆç«¯
            terminals = [
                ["gnome-terminal", "--working-directory", path or os.getcwd()],
                ["konsole", "--workdir", path or os.getcwd()],
                ["xterm", "-e", f"cd {path or os.getcwd()} && bash"],
                ["xfce4-terminal", "--working-directory", path or os.getcwd()],
                ["terminator", "--working-directory", path or os.getcwd()],
                ["urxvt", "-cd", path or os.getcwd()]
            ]
            
            for term_cmd in terminals:
                try:
                    subprocess.Popen(term_cmd)
                    return
                except:
                    continue
            
            # å¦‚æœéƒ½ä¸è¡Œï¼Œå°è¯•ä½¿ç”¨é»˜è®¤ç»ˆç«¯
            subprocess.Popen(["x-terminal-emulator"])
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"æ— æ³•å¯åŠ¨ç³»ç»Ÿç»ˆç«¯: {str(e)}")
    
    def start_viewer_app(self, parent, panel_name, app_config, current_path):
        """å¯åŠ¨æŸ¥çœ‹å™¨/ç¼–è¾‘å™¨åº”ç”¨"""
        try:
            command = app_config.get("command", "")
            app_name = app_config.get("name", "Unknown")
            
            # åˆ›å»ºæŸ¥çœ‹å™¨æ¡†æ¶
            viewer_frame = ttk.Frame(parent)
            viewer_frame.pack(fill=tk.BOTH, expand=True)
            
            # æ§åˆ¶æ 
            control_frame = ttk.Frame(viewer_frame)
            control_frame.pack(fill=tk.X, padx=5, pady=5)
            
            ttk.Label(control_frame, text=f"{app_name}").pack(side=tk.LEFT)
            
            # æ–‡ä»¶é€‰æ‹©æŒ‰é’®
            select_btn = ttk.Button(control_frame, text="é€‰æ‹©æ–‡ä»¶",
                                   command=lambda: self.select_file_for_viewer(panel_name, app_config))
            select_btn.pack(side=tk.RIGHT, padx=5)
            
            # æŸ¥çœ‹å™¨æ˜¾ç¤ºåŒºåŸŸ
            display_frame = ttk.Frame(viewer_frame)
            display_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=(0, 5))
            
            # æ˜¾ç¤ºå½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨
            file_list = tk.Listbox(display_frame, selectmode=tk.SINGLE)
            scrollbar = ttk.Scrollbar(display_frame, orient=tk.VERTICAL, command=file_list.yview)
            file_list.configure(yscrollcommand=scrollbar.set)
            
            file_list.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
            
            # åŠ è½½æ–‡ä»¶åˆ—è¡¨
            try:
                files = os.listdir(current_path)
                for f in files:
                    file_list.insert(tk.END, f)
            except Exception as e:
                file_list.insert(tk.END, f"é”™è¯¯: {str(e)}")
            
            # åŒå‡»æ–‡ä»¶æ‰“å¼€
            def on_file_double_click(event):
                selection = file_list.curselection()
                if selection:
                    filename = file_list.get(selection[0])
                    filepath = os.path.join(current_path, filename)
                    self.open_file_with_app(app_config, filepath)
            
            file_list.bind("<Double-Button-1>", on_file_double_click)
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯åŠ¨æŸ¥çœ‹å™¨å¤±è´¥: {str(e)}")
    
    def select_file_for_viewer(self, panel_name, app_config):
        """ä¸ºæŸ¥çœ‹å™¨é€‰æ‹©æ–‡ä»¶"""
        current_path = self.left_panel_path if panel_name == "left" else self.right_panel_path
        
        # æ ¹æ®åº”ç”¨ç±»å‹é€‰æ‹©æ–‡ä»¶è¿‡æ»¤å™¨
        app_type = None
        for key in ["text_editors", "image_viewers", "pdf_viewers", "video_players"]:
            if any(app.get("name") == app_config.get("name") for app in self.app_config.get(key, [])):
                app_type = key
                break
        
        # è®¾ç½®æ–‡ä»¶ç±»å‹è¿‡æ»¤å™¨
        filetypes = []
        if app_type == "text_editors":
            filetypes = [("æ–‡æœ¬æ–‡ä»¶", "*.txt *.md *.py *.js *.html *.css *.json *.xml"),
                        ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
        elif app_type == "image_viewers":
            filetypes = [("å›¾ç‰‡æ–‡ä»¶", "*.jpg *.jpeg *.png *.gif *.bmp *.svg"),
                        ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
        elif app_type == "pdf_viewers":
            filetypes = [("PDFæ–‡ä»¶", "*.pdf"),
                        ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
        elif app_type == "video_players":
            filetypes = [("è§†é¢‘æ–‡ä»¶", "*.mp4 *.avi *.mkv *.mov *.wmv *.flv"),
                        ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
        else:
            filetypes = [("æ‰€æœ‰æ–‡ä»¶", "*.*")]
        
        filename = filedialog.askopenfilename(
            title="é€‰æ‹©æ–‡ä»¶",
            initialdir=current_path,
            filetypes=filetypes
        )
        
        if filename:
            self.open_file_with_app(app_config, filename)
    
    def open_file_with_app(self, app_config, filepath):
        """ä½¿ç”¨æŒ‡å®šåº”ç”¨æ‰“å¼€æ–‡ä»¶"""
        try:
            command = app_config.get("command", "")
            args = app_config.get("args", [])
            
            # æ›¿æ¢æ–‡ä»¶è·¯å¾„å‚æ•°
            processed_args = []
            for arg in args:
                if "{file}" in arg:
                    arg = arg.replace("{file}", filepath)
                processed_args.append(arg)
            
            # å¯åŠ¨å¤–éƒ¨åº”ç”¨
            subprocess.Popen([command] + processed_args)
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"æ— æ³•æ‰“å¼€æ–‡ä»¶: {str(e)}")
    
    def start_browser_app(self, parent, panel_name, app_config):
        """å¯åŠ¨æµè§ˆå™¨åº”ç”¨"""
        try:
            command = app_config.get("command", "firefox")
            app_name = app_config.get("name", "Unknown")
            
            # åˆ›å»ºæµè§ˆå™¨æ¡†æ¶
            browser_frame = ttk.Frame(parent)
            browser_frame.pack(fill=tk.BOTH, expand=True)
            
            # æ§åˆ¶æ 
            control_frame = ttk.Frame(browser_frame)
            control_frame.pack(fill=tk.X, padx=5, pady=5)
            
            # URLè¾“å…¥æ¡†
            url_var = tk.StringVar(value="https://www.google.com")
            url_entry = ttk.Entry(control_frame, textvariable=url_var, width=50)
            url_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 5))
            
            def go_url():
                url = url_var.get()
                try:
                    subprocess.Popen([command, url])
                except Exception as e:
                    messagebox.showerror("é”™è¯¯", f"æ— æ³•æ‰“å¼€ç½‘å€: {str(e)}")
            
            go_btn = ttk.Button(control_frame, text="è®¿é—®", command=go_url)
            go_btn.pack(side=tk.RIGHT)
            
            # å¿«é€Ÿè®¿é—®æŒ‰é’®
            quick_frame = ttk.Frame(browser_frame)
            quick_frame.pack(fill=tk.X, padx=5, pady=(0, 5))
            
            quick_sites = [
                ("Google", "https://www.google.com"),
                ("GitHub", "https://github.com"),
                ("YouTube", "https://www.youtube.com"),
                ("Wikipedia", "https://www.wikipedia.org")
            ]
            
            for name, url in quick_sites:
                btn = ttk.Button(quick_frame, text=name,
                               command=lambda u=url: subprocess.Popen([command, u]))
                btn.pack(side=tk.LEFT, padx=2)
            
            # æµè§ˆå™¨æ¨¡æ‹ŸåŒºåŸŸ
            display_text = tk.Text(browser_frame, wrap=tk.WORD, height=15)
            display_text.insert(tk.END, f"æµè§ˆå™¨: {app_name}\n")
            display_text.insert(tk.END, "="*50 + "\n\n")
            display_text.insert(tk.END, "è¿™æ˜¯ä¸€ä¸ªæµè§ˆå™¨æ¨¡æ‹Ÿç•Œé¢ã€‚\n")
            display_text.insert(tk.END, "åœ¨ä¸Šæ–¹è¾“å…¥ç½‘å€å¹¶ç‚¹å‡»'è®¿é—®'æŒ‰é’®ï¼Œ\n")
            display_text.insert(tk.END, "å°†åœ¨çœŸæ­£çš„æµè§ˆå™¨ä¸­æ‰“å¼€ç½‘é¡µã€‚\n\n")
            display_text.insert(tk.END, "å¸¸ç”¨ç½‘ç«™å·²æä¾›å¿«æ·æŒ‰é’®ã€‚\n")
            display_text.configure(state=tk.DISABLED)
            
            scrollbar = ttk.Scrollbar(browser_frame, orient=tk.VERTICAL, command=display_text.yview)
            display_text.configure(yscrollcommand=scrollbar.set)
            
            display_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
            scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯åŠ¨æµè§ˆå™¨å¤±è´¥: {str(e)}")
    
    def start_dev_tool(self, parent, panel_name, app_config, current_path):
        """å¯åŠ¨å¼€å‘å·¥å…·"""
        try:
            command = app_config.get("command", "")
            app_name = app_config.get("name", "Unknown")
            args = app_config.get("args", [])
            
            # åˆ›å»ºå¼€å‘å·¥å…·æ¡†æ¶
            dev_frame = ttk.Frame(parent)
            dev_frame.pack(fill=tk.BOTH, expand=True)
            
            # æ§åˆ¶æ 
            control_frame = ttk.Frame(dev_frame)
            control_frame.pack(fill=tk.X, padx=5, pady=5)
            
            ttk.Label(control_frame, text=f"{app_name}").pack(side=tk.LEFT)
            
            # æ‰§è¡ŒæŒ‰é’®
            if command == "python3" and "-i" in args:
                # Pythonäº¤äº’å¼ç¯å¢ƒ
                run_btn = ttk.Button(control_frame, text="è¿è¡ŒPythonè„šæœ¬",
                                    command=self.run_python_script)
                run_btn.pack(side=tk.RIGHT)
                
                # Pythonäº¤äº’å¼ç•Œé¢
                python_frame = ttk.Frame(dev_frame)
                python_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=(0, 5))
                
                python_text = tk.Text(python_frame, wrap=tk.WORD, bg="black", fg="white",
                                    font=("Monospace", 10))
                scrollbar = ttk.Scrollbar(python_frame, orient=tk.VERTICAL, command=python_text.yview)
                python_text.configure(yscrollcommand=scrollbar.set)
                
                python_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
                scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
                
                python_text.insert(tk.END, f"Python {sys.version}\n")
                python_text.insert(tk.END, f"å·¥ä½œç›®å½•: {current_path}\n")
                python_text.insert(tk.END, "="*50 + "\n")
                python_text.insert(tk.END, ">>> ")
                
            elif command == "node":
                # Node.js REPLç¯å¢ƒ
                ttk.Label(control_frame, text="Node.js REPLç¯å¢ƒ").pack(side=tk.LEFT)
                
            elif command == "bash":
                # Bash Shell
                ttk.Label(control_frame, text="Bash Shellç¯å¢ƒ").pack(side=tk.LEFT)
                
                # å¯åŠ¨ç³»ç»Ÿç»ˆç«¯
                sys_term_btn = ttk.Button(control_frame, text="å¯åŠ¨Bashç»ˆç«¯",
                                         command=lambda: self.launch_system_terminal(current_path))
                sys_term_btn.pack(side=tk.RIGHT)
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¯åŠ¨å¼€å‘å·¥å…·å¤±è´¥: {str(e)}")
    
    def run_python_script(self):
        """è¿è¡ŒPythonè„šæœ¬"""
        filename = filedialog.askopenfilename(
            title="é€‰æ‹©Pythonè„šæœ¬",
            initialdir=os.getcwd(),
            filetypes=[("Pythonæ–‡ä»¶", "*.py"), ("æ‰€æœ‰æ–‡ä»¶", "*.*")]
        )
        
        if filename:
            try:
                result = subprocess.run(
                    ["python3", filename],
                    capture_output=True,
                    text=True,
                    timeout=10
                )
                
                # æ˜¾ç¤ºç»“æœ
                self.show_message_dialog(
                    "Pythonè„šæœ¬æ‰§è¡Œç»“æœ",
                    f"æ–‡ä»¶: {filename}\n\næ ‡å‡†è¾“å‡º:\n{result.stdout}\n\né”™è¯¯è¾“å‡º:\n{result.stderr}"
                )
                
            except subprocess.TimeoutExpired:
                messagebox.showwarning("è­¦å‘Š", "è„šæœ¬æ‰§è¡Œè¶…æ—¶")
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"æ‰§è¡Œå¤±è´¥: {str(e)}")
    
    def switch_app_mode(self, panel_name, mode):
        """åˆ‡æ¢åº”ç”¨æ¨¡å¼"""
        # æŸ¥æ‰¾å¯¹åº”çš„åº”ç”¨é…ç½®
        app_config = None
        
        if mode == "file_manager":
            apps = self.app_config.get("file_managers", [])
        elif mode == "terminal":
            apps = self.app_config.get("terminal_apps", [])
        elif mode == "editor":
            apps = self.app_config.get("text_editors", [])
        elif mode == "image_viewer":
            apps = self.app_config.get("image_viewers", [])
        elif mode == "pdf_viewer":
            apps = self.app_config.get("pdf_viewers", [])
        elif mode == "video_player":
            apps = self.app_config.get("video_players", [])
        elif mode == "web_browser":
            apps = self.app_config.get("web_browsers", [])
        elif mode == "dev_tools":
            apps = self.app_config.get("development_tools", [])
        else:
            return
        
        if apps:
            app_config = apps[0]  # ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨åº”ç”¨
        
        if app_config:
            self.select_app_for_panel(panel_name, mode, app_config)
    
    def quick_switch_app(self, mode):
        """å¿«é€Ÿåˆ‡æ¢åº”ç”¨ï¼ˆæ ¹æ®å½“å‰æ´»åŠ¨é¢æ¿ï¼‰"""
        if self.active_panel == "left":
            self.switch_app_mode("left", mode)
        else:
            self.switch_app_mode("right", mode)
    
    def quick_navigate(self, path):
        """å¿«é€Ÿå¯¼èˆªåˆ°æŒ‡å®šè·¯å¾„"""
        if self.active_panel == "left":
            self.left_panel_path = os.path.abspath(path)
            if self.left_app_mode == "file_manager":
                self.load_panel("left")
        else:
            self.right_panel_path = os.path.abspath(path)
            if self.right_app_mode == "file_manager":
                self.load_panel("right")
    
    def create_statusbar(self, parent):
        """åˆ›å»ºçŠ¶æ€æ """
        self.statusbar = ttk.Frame(parent, relief=tk.SUNKEN)
        self.statusbar.pack(fill=tk.X, pady=(5, 0))
        
        # åº”ç”¨æ¨¡å¼æ˜¾ç¤º
        self.app_mode_label = ttk.Label(self.statusbar, text="æ¨¡å¼: æ–‡ä»¶ç®¡ç†å™¨")
        self.app_mode_label.pack(side=tk.LEFT, padx=5)
        
        # ç£ç›˜ä¿¡æ¯
        self.disk_label = ttk.Label(self.statusbar, text="ç£ç›˜: æ­£åœ¨æ£€æŸ¥...")
        self.disk_label.pack(side=tk.LEFT, padx=5)
        
        # é€‰ä¸­æ–‡ä»¶ä¿¡æ¯
        self.selection_label = ttk.Label(self.statusbar, text="å°±ç»ª")
        self.selection_label.pack(side=tk.LEFT, padx=5, fill=tk.X, expand=True)
        
        # æ—¶é—´æ˜¾ç¤º
        self.time_label = ttk.Label(self.statusbar, text="", font=("Arial", 9))
        self.time_label.pack(side=tk.RIGHT, padx=5)
        
        # æ›´æ–°æ—¶é’Ÿ
        self.update_clock()
    
    def create_context_menu(self):
        """åˆ›å»ºå³é”®èœå•"""
        self.context_menu = tk.Menu(self.root, tearoff=0)
        
        menu_items = [
            ("æ‰“å¼€", self.open_selected),
            ("ä½¿ç”¨åº”ç”¨æ‰“å¼€", self.open_with_app),
            ("å¤åˆ¶", self.copy_selected),
            ("ç§»åŠ¨åˆ°", self.move_selected),
            ("é‡å‘½å", self.rename_item),
            ("åˆ é™¤", self.delete_item),
            ("æƒé™", self.change_permissions),
            ("å±æ€§", self.show_properties),
            ("---", None),
            ("åœ¨ç»ˆç«¯ä¸­æ‰“å¼€", self.open_in_terminal),
            ("åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€", self.open_in_editor),
            ("---", None),
            ("æ–°å»ºæ–‡ä»¶å¤¹", self.create_folder),
            ("æ–°å»ºæ–‡ä»¶", self.create_file),
        ]
        
        for label, command in menu_items:
            if label == "---":
                self.context_menu.add_separator()
            else:
                self.context_menu.add_command(label=label, command=command)
    
    def bind_shortcuts(self):
        """ç»‘å®šå¿«æ·é”®"""
        # å…¨å±€å¿«æ·é”®
        self.root.bind("<F1>", lambda e: self.show_help())
        self.root.bind("<F2>", lambda e: self.refresh_panels())
        self.root.bind("<F3>", lambda e: self.copy_to_right())
        self.root.bind("<F4>", lambda e: self.copy_to_left())
        self.root.bind("<F5>", lambda e: self.delete_item())
        self.root.bind("<F6>", lambda e: self.rename_item())
        self.root.bind("<F7>", lambda e: self.change_permissions())
        self.root.bind("<F8>", lambda e: self.show_explanation())
        self.root.bind("<Tab>", lambda e: self.switch_panel())
        self.root.bind("<Delete>", lambda e: self.delete_item())
        self.root.bind("<BackSpace>", lambda e: self.go_up())
        self.root.bind("<Control-q>", lambda e: self.root.quit())
        self.root.bind("<F11>", lambda e: self.toggle_fullscreen())
        self.root.bind("<Control-m>", lambda e: self.show_app_selector())
        
        # é¢æ¿åˆ‡æ¢å¿«æ·é”®
        self.root.bind("<Alt-Left>", lambda e: self.activate_panel("left"))
        self.root.bind("<Alt-Right>", lambda e: self.activate_panel("right"))
        
        # åº”ç”¨æ¨¡å¼å¿«é€Ÿåˆ‡æ¢
        self.root.bind("<Control-1>", lambda e: self.quick_switch_app("file_manager"))
        self.root.bind("<Control-2>", lambda e: self.quick_switch_app("terminal"))
        self.root.bind("<Control-3>", lambda e: self.quick_switch_app("editor"))
        self.root.bind("<Control-4>", lambda e: self.quick_switch_app("image_viewer"))
        self.root.bind("<Control-5>", lambda e: self.quick_switch_app("pdf_viewer"))
    
    def update_clock(self):
        """æ›´æ–°æ—¶é’Ÿæ˜¾ç¤º"""
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.time_label.config(text=current_time)
        self.root.after(1000, self.update_clock)
    
    def load_panel(self, panel_name):
        """åŠ è½½é¢æ¿å†…å®¹"""
        print(f"åŠ è½½é¢æ¿: {panel_name}")
        if panel_name == "left":
            tree = self.left_tree
            current_path = self.left_panel_path
        else:
            tree = self.right_tree
            current_path = self.right_panel_path
        
        # æ¸…ç©ºæ ‘
        for item in tree.get_children():
            tree.delete(item)
        
        try:
            # æ·»åŠ ä¸Šçº§ç›®å½•
            if current_path != "/":
                tree.insert("", "end", text="..", values=("ç›®å½•", "", "", ""))
            
            # åˆ—å‡ºæ–‡ä»¶
            items = os.listdir(current_path)
            for item in sorted(items):
                try:
                    item_path = os.path.join(current_path, item)
                    stat_info = os.stat(item_path)
                    
                    if os.path.isdir(item_path):
                        item_type = "ç›®å½•"
                        size = ""
                    else:
                        item_type = "æ–‡ä»¶"
                        size = self.format_size(stat_info.st_size)
                    
                    # æƒé™
                    import stat
                    mode = stat.S_IMODE(stat_info.st_mode)
                    permission = oct(mode)[-3:]
                    
                    # æ‰€æœ‰è€…
                    import pwd
                    try:
                        owner = pwd.getpwuid(stat_info.st_uid).pw_name
                    except:
                        owner = str(stat_info.st_uid)
                    
                    tree.insert("", "end", text=item, 
                              values=(item_type, size, permission, owner))
                except:
                    tree.insert("", "end", text=item, 
                              values=("æœªçŸ¥", "?", "???", "?"))
        except Exception as e:
            print(f"åŠ è½½é”™è¯¯: {e}")
    
    def format_size(self, size):
        """æ ¼å¼åŒ–æ–‡ä»¶å¤§å°"""
        for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
            if size < 1024.0:
                return f"{size:.1f} {unit}"
            size /= 1024.0
        return f"{size:.1f} PB"
    
    def on_item_double_click(self, panel_name):
        """åŒå‡»é¡¹ç›®äº‹ä»¶"""
        print(f"åŒå‡»é¢æ¿: {panel_name}")
        if panel_name == "left":
            tree = self.left_tree
            current_path = self.left_panel_path
        else:
            tree = self.right_tree
            current_path = self.right_panel_path
        
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            # è¿”å›ä¸Šçº§
            new_path = os.path.dirname(current_path)
            if panel_name == "left":
                self.left_panel_path = new_path
                self.left_path_label.config(text=new_path)
            else:
                self.right_panel_path = new_path
                self.right_path_label.config(text=new_path)
            self.load_panel(panel_name)
            return
        
        item_path = os.path.join(current_path, name)
        
        if os.path.isdir(item_path):
            # è¿›å…¥ç›®å½•
            if panel_name == "left":
                self.left_panel_path = item_path
                self.left_path_label.config(text=item_path)
            else:
                self.right_panel_path = item_path
                self.right_path_label.config(text=item_path)
            self.load_panel(panel_name)
        else:
            # æ‰“å¼€æ–‡ä»¶
            self.open_file(item_path)
    
    def on_item_click(self, panel_name):
        """å•å‡»é¡¹ç›®äº‹ä»¶"""
        self.active_panel = panel_name
        self.update_selection_info()
    
    def get_active_tree(self):
        """è·å–å½“å‰æ´»åŠ¨é¢æ¿çš„æ ‘è§†å›¾"""
        return self.left_tree if self.active_panel == "left" else self.right_tree
    
    def show_context_menu(self, event, panel_name):
        """æ˜¾ç¤ºå³é”®èœå•"""
        # è®¾ç½®æ´»åŠ¨é¢æ¿
        self.active_panel = panel_name
        
        # è·å–ç‚¹å‡»ä½ç½®
        x, y = event.x_root, event.y_root
        
        try:
            # æ˜¾ç¤ºå³é”®èœå•
            self.context_menu.tk_popup(x, y)
        finally:
            self.context_menu.grab_release()
    
    def open_selected(self):
        """æ‰“å¼€é€‰ä¸­çš„é¡¹ç›®"""
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        item_path = os.path.join(current_path, name)
        self.open_file(item_path)
    
    def open_file(self, filepath):
        """æ‰“å¼€æ–‡ä»¶"""
        print(f"æ‰“å¼€æ–‡ä»¶: {filepath}")
        if os.path.isdir(filepath):
            # å¦‚æœæ˜¯ç›®å½•ï¼Œå¯¼èˆªåˆ°è¯¥ç›®å½•
            if self.active_panel == "left":
                self.left_panel_path = filepath
                self.left_path_label.config(text=filepath)
                self.load_panel("left")
            else:
                self.right_panel_path = filepath
                self.right_path_label.config(text=filepath)
                self.load_panel("right")
        else:
            # å¦‚æœæ˜¯æ–‡ä»¶ï¼Œç”¨ç³»ç»Ÿé»˜è®¤ç¨‹åºæ‰“å¼€
            try:
                import subprocess
                subprocess.Popen(["xdg-open", filepath])
            except:
                try:
                    import webbrowser
                    webbrowser.open("file://" + filepath)
                except Exception as e:
                    from tkinter import messagebox
                    messagebox.showerror("é”™è¯¯", f"æ— æ³•æ‰“å¼€æ–‡ä»¶: {e}")
    
    def open_with_app(self):
        """ä½¿ç”¨æŒ‡å®šåº”ç”¨æ‰“å¼€"""
        from tkinter import Toplevel, Listbox, Button
        import subprocess
        
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        filepath = os.path.join(current_path, name)
        
        dialog = Toplevel(self.root)
        dialog.title("é€‰æ‹©åº”ç”¨")
        dialog.geometry("400x300")
        
        app_list = Listbox(dialog, selectmode="single")
        apps = []
        
        # ä»é…ç½®è·å–åº”ç”¨
        if self.app_config:
            for category in ["text_editors", "image_viewers", "pdf_viewers", "video_players"]:
                for app in self.app_config.get(category, []):
                    apps.append(app)
        
        # æ·»åŠ é»˜è®¤åº”ç”¨
        default_apps = [
            {"name": "æ–‡æœ¬ç¼–è¾‘å™¨", "command": "gedit"},
            {"name": "å›¾ç‰‡æŸ¥çœ‹å™¨", "command": "eog"},
            {"name": "PDFæŸ¥çœ‹å™¨", "command": "evince"},
            {"name": "åª’ä½“æ’­æ”¾å™¨", "command": "vlc"}
        ]
        
        for app in default_apps + apps:
            display_name = app.get("name", "æœªçŸ¥åº”ç”¨")
            app_list.insert("end", display_name)
        
        app_list.pack(fill="both", expand=True, padx=10, pady=10)
        
        def open_selected():
            selection = app_list.curselection()
            if selection:
                idx = selection[0]
                if idx < len(default_apps):
                    app = default_apps[idx]
                else:
                    app_idx = idx - len(default_apps)
                    if app_idx < len(apps):
                        app = apps[app_idx]
                
                try:
                    subprocess.Popen([app.get("command", "gedit"), filepath])
                except Exception as e:
                    from tkinter import messagebox
                    messagebox.showerror("é”™è¯¯", f"æ— æ³•å¯åŠ¨åº”ç”¨: {e}")
            
            dialog.destroy()
        
        Button(dialog, text="æ‰“å¼€", command=open_selected).pack(side="left", padx=20, pady=10)
        Button(dialog, text="å–æ¶ˆ", command=dialog.destroy).pack(side="right", padx=20, pady=10)
    
    def open_in_terminal(self):
        """åœ¨ç»ˆç«¯ä¸­æ‰“å¼€"""
        import subprocess
        
        tree = self.get_active_tree()
        selection = tree.selection()
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        
        if selection:
            item = selection[0]
            values = tree.item(item)
            name = values.get('text', '')
            
            if name == "..":
                target_path = os.path.dirname(current_path)
            else:
                target_path = os.path.join(current_path, name)
                if not os.path.isdir(target_path):
                    target_path = os.path.dirname(target_path)
        else:
            target_path = current_path
        
        self.launch_system_terminal(target_path)
    
    def open_in_editor(self):
        """åœ¨ç¼–è¾‘å™¨ä¸­æ‰“å¼€"""
        import subprocess
        
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        filepath = os.path.join(current_path, name)
        
        if os.path.isfile(filepath):
            try:
                subprocess.Popen(["gedit", filepath])
            except:
                try:
                    subprocess.Popen(["mousepad", filepath])
                except:
                    from tkinter import messagebox
                    messagebox.showerror("é”™è¯¯", "æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„æ–‡æœ¬ç¼–è¾‘å™¨")
    
    def copy_selected(self):
        """å¤åˆ¶é€‰ä¸­çš„é¡¹ç›®"""
        from tkinter import filedialog, messagebox
        import shutil
        
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        source_path = os.path.join(current_path, name)
        
        target_dir = filedialog.askdirectory(title="é€‰æ‹©ç›®æ ‡ç›®å½•")
        if target_dir:
            try:
                target_path = os.path.join(target_dir, name)
                if os.path.isdir(source_path):
                    shutil.copytree(source_path, target_path)
                else:
                    shutil.copy2(source_path, target_path)
                messagebox.showinfo("æˆåŠŸ", f"å·²å¤åˆ¶åˆ°: {target_path}")
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"å¤åˆ¶å¤±è´¥: {e}")
    
    def copy_to_right(self):
        """ä»å·¦é¢æ¿å¤åˆ¶åˆ°å³é¢æ¿"""
        self.copy_between_panels("left", "right")
    
    def copy_to_left(self):
        """ä»å³é¢æ¿å¤åˆ¶åˆ°å·¦é¢æ¿"""
        self.copy_between_panels("right", "left")
    
    def copy_between_panels(self, source_panel, target_panel):
        """åœ¨é¢æ¿é—´å¤åˆ¶æ–‡ä»¶"""
        from tkinter import messagebox
        import shutil
        
        if source_panel == "left":
            source_tree = self.left_tree
            source_path = self.left_panel_path
        else:
            source_tree = self.right_tree
            source_path = self.right_panel_path
        
        if target_panel == "left":
            target_path = self.left_panel_path
        else:
            target_path = self.right_panel_path
        
        selection = source_tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = source_tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        source_full = os.path.join(source_path, name)
        target_full = os.path.join(target_path, name)
        
        try:
            if os.path.isdir(source_full):
                if os.path.exists(target_full):
                    response = messagebox.askyesno("ç¡®è®¤", f"ç›®å½• {name} å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ")
                    if not response:
                        return
                    shutil.rmtree(target_full)
                shutil.copytree(source_full, target_full)
            else:
                shutil.copy2(source_full, target_full)
            
            messagebox.showinfo("æˆåŠŸ", f"å·²å¤åˆ¶åˆ°: {target_path}")
            
            # åˆ·æ–°ç›®æ ‡é¢æ¿
            if target_panel == "left":
                self.load_panel("left")
            else:
                self.load_panel("right")
                
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"å¤åˆ¶å¤±è´¥: {e}")
    
    def move_selected(self):
        """ç§»åŠ¨é€‰ä¸­çš„é¡¹ç›®"""
        from tkinter import filedialog, messagebox
        import shutil
        
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        source_path = os.path.join(current_path, name)
        
        target_dir = filedialog.askdirectory(title="é€‰æ‹©ç›®æ ‡ç›®å½•")
        if target_dir:
            try:
                target_path = os.path.join(target_dir, name)
                shutil.move(source_path, target_path)
                messagebox.showinfo("æˆåŠŸ", f"å·²ç§»åŠ¨åˆ°: {target_path}")
                
                # åˆ·æ–°å½“å‰é¢æ¿
                self.load_panel(self.active_panel)
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"ç§»åŠ¨å¤±è´¥: {e}")
    
    def rename_item(self):
        """é‡å‘½åé€‰ä¸­çš„é¡¹ç›®"""
        from tkinter import simpledialog, messagebox
        
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        old_name = values.get('text', '')
        
        if old_name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        old_path = os.path.join(current_path, old_name)
        
        new_name = simpledialog.askstring("é‡å‘½å", f"è¾“å…¥æ–°åç§°:", initialvalue=old_name)
        if new_name and new_name != old_name:
            try:
                new_path = os.path.join(current_path, new_name)
                os.rename(old_path, new_path)
                
                # åˆ·æ–°é¢æ¿
                self.load_panel(self.active_panel)
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"é‡å‘½åå¤±è´¥: {e}")
    
    def delete_item(self):
        """åˆ é™¤é€‰ä¸­çš„é¡¹ç›®"""
        from tkinter import messagebox
        import shutil
        
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        target_path = os.path.join(current_path, name)
        
        response = messagebox.askyesno("ç¡®è®¤åˆ é™¤", f"ç¡®å®šè¦åˆ é™¤ '{name}' å—ï¼Ÿ")
        if response:
            try:
                if os.path.isdir(target_path):
                    shutil.rmtree(target_path)
                else:
                    os.remove(target_path)
                
                # åˆ·æ–°é¢æ¿
                self.load_panel(self.active_panel)
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"åˆ é™¤å¤±è´¥: {e}")
    
    def change_permissions(self):
        """ä¿®æ”¹æ–‡ä»¶æƒé™"""
        from tkinter import Toplevel, Scale, Label, Button, messagebox
        import stat
        
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        target_path = os.path.join(current_path, name)
        
        try:
            current_mode = os.stat(target_path).st_mode
            current_octal = oct(stat.S_IMODE(current_mode))[-3:]
        except:
            messagebox.showerror("é”™è¯¯", "æ— æ³•è·å–æ–‡ä»¶æƒé™")
            return
        
        dialog = Toplevel(self.root)
        dialog.title("ä¿®æ”¹æƒé™")
        dialog.geometry("300x300")
        
        Label(dialog, text=f"æ–‡ä»¶: {name}").pack(pady=10)
        Label(dialog, text=f"å½“å‰æƒé™: {current_octal}").pack()
        
        def update_label(val):
            octal_val = int(val)
            octal_str = oct(octal_val)[2:].zfill(3)
            perm_label.config(text=f"æ–°æƒé™: {octal_str}")
        
        scale = Scale(dialog, from_=0, to=511, orient="horizontal", 
                     command=update_label)
        scale.set(int(current_octal, 8))
        scale.pack(pady=20)
        
        perm_label = Label(dialog, text=f"æ–°æƒé™: {current_octal}")
        perm_label.pack()
        
        def apply_permissions():
            new_mode = int(scale.get())
            try:
                os.chmod(target_path, new_mode)
                messagebox.showinfo("æˆåŠŸ", "æƒé™å·²ä¿®æ”¹")
                dialog.destroy()
                
                # åˆ·æ–°é¢æ¿
                self.load_panel(self.active_panel)
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"ä¿®æ”¹æƒé™å¤±è´¥: {e}")
        
        Button(dialog, text="åº”ç”¨", command=apply_permissions).pack(pady=10)
        Button(dialog, text="å–æ¶ˆ", command=dialog.destroy).pack()
    
    def show_explanation(self):
        """æ˜¾ç¤ºæ–‡ä»¶è§£é‡Š"""
        from tkinter import messagebox
        from datetime import datetime
        import stat
        
        tree = self.get_active_tree()
        selection = tree.selection()
        if not selection:
            return
        
        item = selection[0]
        values = tree.item(item)
        name = values.get('text', '')
        
        if name == "..":
            return
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        target_path = os.path.join(current_path, name)
        
        try:
            stat_info = os.stat(target_path)
            size = stat_info.st_size
            mtime = datetime.fromtimestamp(stat_info.st_mtime)
            atime = datetime.fromtimestamp(stat_info.st_atime)
            ctime = datetime.fromtimestamp(stat_info.st_ctime)
            mode = stat.S_IMODE(stat_info.st_mode)
            
            info_text = f"æ–‡ä»¶: {name}\n"
            info_text += f"è·¯å¾„: {target_path}\n"
            info_text += f"å¤§å°: {self.format_size(size)}\n"
            info_text += f"ç±»å‹: {'ç›®å½•' if os.path.isdir(target_path) else 'æ–‡ä»¶'}\n"
            info_text += f"æƒé™: {oct(mode)}\n"
            info_text += f"ä¿®æ”¹æ—¶é—´: {mtime}\n"
            info_text += f"è®¿é—®æ—¶é—´: {atime}\n"
            info_text += f"åˆ›å»ºæ—¶é—´: {ctime}"
            
            try:
                import pwd
                import grp
                owner = pwd.getpwuid(stat_info.st_uid).pw_name
                group = grp.getgrgid(stat_info.st_gid).gr_name
                info_text += f"\næ‰€æœ‰è€…: {owner}\n"
                info_text += f"ç”¨æˆ·ç»„: {group}"
            except:
                pass
            
            self.show_message_dialog("æ–‡ä»¶ä¿¡æ¯", info_text)
            
        except Exception as e:
            messagebox.showerror("é”™è¯¯", f"æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯: {e}")
    
    def show_properties(self):
        """æ˜¾ç¤ºæ–‡ä»¶å±æ€§"""
        self.show_explanation()  # å¤ç”¨show_explanationçš„åŠŸèƒ½
    
    def create_folder(self):
        """åˆ›å»ºæ–°æ–‡ä»¶å¤¹"""
        from tkinter import simpledialog, messagebox
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        
        folder_name = simpledialog.askstring("æ–°å»ºæ–‡ä»¶å¤¹", "è¾“å…¥æ–‡ä»¶å¤¹åç§°:")
        if folder_name:
            try:
                new_folder_path = os.path.join(current_path, folder_name)
                os.makedirs(new_folder_path, exist_ok=True)
                
                # åˆ·æ–°é¢æ¿
                self.load_panel(self.active_panel)
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥: {e}")
    
    def create_file(self):
        """åˆ›å»ºæ–°æ–‡ä»¶"""
        from tkinter import simpledialog, messagebox
        
        current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
        
        file_name = simpledialog.askstring("æ–°å»ºæ–‡ä»¶", "è¾“å…¥æ–‡ä»¶åç§°:")
        if file_name:
            try:
                new_file_path = os.path.join(current_path, file_name)
                with open(new_file_path, 'w') as f:
                    f.write("")
                
                # åˆ·æ–°é¢æ¿
                self.load_panel(self.active_panel)
                
            except Exception as e:
                messagebox.showerror("é”™è¯¯", f"åˆ›å»ºæ–‡ä»¶å¤±è´¥: {e}")
    
    def go_up(self):
        """è¿”å›ä¸Šçº§ç›®å½•"""
        if self.active_panel == "left":
            if self.left_panel_path != "/":
                self.left_panel_path = os.path.dirname(self.left_panel_path)
                self.left_path_label.config(text=self.left_panel_path)
                self.load_panel("left")
        else:
            if self.right_panel_path != "/":
                self.right_panel_path = os.path.dirname(self.right_panel_path)
                self.right_path_label.config(text=self.right_panel_path)
                self.load_panel("right")
    
    def switch_panel(self):
        """åˆ‡æ¢æ´»åŠ¨é¢æ¿"""
        self.active_panel = "right" if self.active_panel == "left" else "left"
        self.update_status()
    
    def activate_panel(self, panel_name):
        """æ¿€æ´»æŒ‡å®šé¢æ¿"""
        self.active_panel = panel_name
        self.update_status()
    
    def on_path_changed(self, event=None):
        """è·¯å¾„è¾“å…¥æ¡†æ”¹å˜äº‹ä»¶"""
        from tkinter import messagebox
        
        new_path = self.path_var.get()
        if os.path.isdir(new_path):
            if self.active_panel == "left":
                self.left_panel_path = os.path.abspath(new_path)
                self.left_path_label.config(text=self.left_panel_path)
                self.load_panel("left")
            else:
                self.right_panel_path = os.path.abspath(new_path)
                self.right_path_label.config(text=self.right_panel_path)
                self.load_panel("right")
        else:
            messagebox.showerror("é”™è¯¯", "è·¯å¾„ä¸å­˜åœ¨æˆ–ä¸æ˜¯ç›®å½•")
    
    def on_separator_drag_start(self, event):
        """å¼€å§‹æ‹–åŠ¨åˆ†éš”æ¡"""
        self.separator_drag_start_x = event.x
        self.left_width_orig = self.left_app_container.winfo_width()
        self.right_width_orig = self.right_app_container.winfo_width()
    
    def on_separator_drag(self, event):
        """æ‹–åŠ¨åˆ†éš”æ¡"""
        delta = event.x - self.separator_drag_start_x
        # è¿™é‡Œå¯ä»¥æ·»åŠ è°ƒæ•´é¢æ¿å®½åº¦çš„é€»è¾‘
        # ç”±äºtkinterå¸ƒå±€é™åˆ¶ï¼Œè¿™é‡Œåªè®°å½•äº‹ä»¶
        pass
    
    def refresh_panels(self):
        """åˆ·æ–°æ‰€æœ‰é¢æ¿"""
        if hasattr(self, 'left_tree') and self.left_app_mode == "file_manager":
            self.load_panel("left")
        if hasattr(self, 'right_tree') and self.right_app_mode == "file_manager":
            self.load_panel("right")
    
    def update_status(self):
        """æ›´æ–°çŠ¶æ€æ """
        # æ›´æ–°ç£ç›˜ä¿¡æ¯
        try:
            import os
            disk_info = os.statvfs(os.path.expanduser("~"))
            total = disk_info.f_blocks * disk_info.f_frsize
            free = disk_info.f_bavail * disk_info.f_frsize
            used = total - free
            percent = (used / total) * 100
            
            self.disk_label.config(
                text=f"ç£ç›˜: {self.format_size(used)} / {self.format_size(total)} ({percent:.1f}%)"
            )
        except:
            self.disk_label.config(text="ç£ç›˜: æœªçŸ¥")
        
        # æ›´æ–°åº”ç”¨æ¨¡å¼æ˜¾ç¤º
        mode_text = f"æ¨¡å¼: {self.left_app_mode} / {self.right_app_mode}"
        self.app_mode_label.config(text=mode_text)
        
        # æ›´æ–°é€‰ä¸­æ–‡ä»¶ä¿¡æ¯
        self.update_selection_info()
    
    def update_selection_info(self):
        """æ›´æ–°é€‰ä¸­é¡¹ç›®ä¿¡æ¯"""
        tree = self.get_active_tree()
        selection = tree.selection()
        
        if selection:
            item = selection[0]
            values = tree.item(item)
            name = values.get('text', '')
            
            if name == "..":
                self.selection_label.config(text="ä¸Šçº§ç›®å½•")
            else:
                current_path = self.left_panel_path if self.active_panel == "left" else self.right_panel_path
                item_path = os.path.join(current_path, name)
                
                try:
                    if os.path.isdir(item_path):
                        try:
                            file_count = len([f for f in os.listdir(item_path) if not f.startswith('.')])
                            info = f"{name} (ç›®å½•, {file_count} ä¸ªé¡¹ç›®)"
                        except:
                            info = f"{name} (ç›®å½•)"
                    else:
                        size = os.path.getsize(item_path)
                        info = f"{name} (æ–‡ä»¶, {self.format_size(size)})"
                    
                    self.selection_label.config(text=info)
                except:
                    self.selection_label.config(text=name)
        else:
            self.selection_label.config(text="å°±ç»ª")
    
    def show_help(self):
        """æ˜¾ç¤ºå¸®åŠ©"""
        self.show_manual()
    
    def toggle_fullscreen(self):
        """åˆ‡æ¢å…¨å±æ¨¡å¼"""
        self.root.attributes("-fullscreen", not self.root.attributes("-fullscreen"))
    
    def batch_rename(self):
        """æ‰¹é‡é‡å‘½å"""
        messagebox.showinfo("åŠŸèƒ½", "æ‰¹é‡é‡å‘½ååŠŸèƒ½å¼€å‘ä¸­...")
    
    def find_files(self):
        """æŸ¥æ‰¾æ–‡ä»¶"""
        messagebox.showinfo("åŠŸèƒ½", "æ–‡ä»¶æŸ¥æ‰¾åŠŸèƒ½å¼€å‘ä¸­...")
    
    def calculate_size(self):
        """è®¡ç®—å¤§å°"""
        messagebox.showinfo("åŠŸèƒ½", "å¤§å°è®¡ç®—åŠŸèƒ½å¼€å‘ä¸­...")
    
    def show_settings(self):
        """æ˜¾ç¤ºè®¾ç½®"""
        messagebox.showinfo("åŠŸèƒ½", "è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...")
    
    def show_manual(self):
        """æ˜¾ç¤ºç”¨æˆ·æ‰‹å†Œ"""
        manual_text = """
        OpenFM å¢å¼ºç‰ˆ - ç”¨æˆ·æ‰‹å†Œ
        
        æ ¸å¿ƒåŠŸèƒ½ï¼š
        1. å¹¶è¡Œåº”ç”¨æ¨¡å¼
           Â· å·¦å³é¢æ¿å¯ç‹¬ç«‹è¿è¡Œä¸åŒåº”ç”¨
           Â· æ”¯æŒæ–‡ä»¶ç®¡ç†å™¨ã€ç»ˆç«¯ã€ç¼–è¾‘å™¨ç­‰
           Â· ç‚¹å‡»â˜°æŒ‰é’®é€‰æ‹©åº”ç”¨
        
        2. åº”ç”¨ç±»å‹ï¼š
           Â· æ–‡ä»¶ç®¡ç†å™¨ï¼šæµè§ˆå’Œç®¡ç†æ–‡ä»¶
           Â· ç»ˆç«¯ï¼šå‘½ä»¤è¡Œæ“ä½œï¼ˆæ”¯æŒè°ƒç”¨ç³»ç»Ÿç»ˆç«¯ï¼‰
           Â· æ–‡æœ¬ç¼–è¾‘å™¨ï¼šç¼–è¾‘æ–‡æœ¬æ–‡ä»¶
           Â· å›¾ç‰‡æŸ¥çœ‹å™¨ï¼šæŸ¥çœ‹å›¾ç‰‡
           Â· PDFæŸ¥çœ‹å™¨ï¼šé˜…è¯»PDFæ–‡æ¡£
           Â· åª’ä½“æ’­æ”¾å™¨ï¼šæ’­æ”¾éŸ³è§†é¢‘
           Â· ç½‘é¡µæµè§ˆå™¨ï¼šæµè§ˆç½‘é¡µ
           Â· å¼€å‘å·¥å…·ï¼šPythonã€Node.jsç­‰
        
        3. å¿«æ·é”®ï¼š
           Â· Ctrl+1-5ï¼šå¿«é€Ÿåˆ‡æ¢åº”ç”¨æ¨¡å¼
           Â· Ctrl+Mï¼šæ˜¾ç¤ºåº”ç”¨é€‰æ‹©å™¨
           Â· F11ï¼šå…¨å±åˆ‡æ¢
           Â· Alt+Left/Rightï¼šåˆ‡æ¢æ´»åŠ¨é¢æ¿
        
        4. å³é”®èœå•ï¼š
           Â· æ”¯æŒå¤šç§æ‰“å¼€æ–¹å¼
           Â· å¿«é€Ÿåœ¨ç»ˆç«¯/ç¼–è¾‘å™¨ä¸­æ‰“å¼€
           Â· å®Œæ•´æ–‡ä»¶æ“ä½œ
        
        æç¤ºï¼š
        1. ç‚¹å‡»"è°ƒç”¨ç³»ç»Ÿç»ˆç«¯"å¯åœ¨å¤–éƒ¨ç»ˆç«¯ä¸­æ“ä½œ
        2. åº”ç”¨åˆ‡æ¢ä¼šä¿å­˜å½“å‰çŠ¶æ€
        3. æ”¯æŒæ‹–æ”¾è°ƒæ•´é¢æ¿å¤§å°
        """
        
        self.show_message_dialog("ç”¨æˆ·æ‰‹å†Œ", manual_text)
    
    def show_shortcuts(self):
        """æ˜¾ç¤ºå¿«æ·é”®"""
        shortcuts_text = """
        å¿«æ·é”®åˆ—è¡¨ï¼š
        
        åº”ç”¨æ§åˆ¶ï¼š
        Ctrl+M          - æ˜¾ç¤ºåº”ç”¨é€‰æ‹©å™¨
        Ctrl+1          - æ–‡ä»¶ç®¡ç†å™¨æ¨¡å¼
        Ctrl+2          - ç»ˆç«¯æ¨¡å¼
        Ctrl+3          - æ–‡æœ¬ç¼–è¾‘å™¨æ¨¡å¼
        Ctrl+4          - å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡å¼
        Ctrl+5          - PDFæŸ¥çœ‹å™¨æ¨¡å¼
        
        è§†å›¾æ§åˆ¶ï¼š
        F11             - å…¨å±åˆ‡æ¢
        Alt+Left        - æ¿€æ´»å·¦é¢æ¿
        Alt+Right       - æ¿€æ´»å³é¢æ¿
        Tab             - åˆ‡æ¢æ´»åŠ¨é¢æ¿
        
        æ–‡ä»¶æ“ä½œï¼š
        F2              - åˆ·æ–°é¢æ¿
        F3              - å¤åˆ¶åˆ°å³ä¾§
        F4              - å¤åˆ¶åˆ°å·¦ä¾§
        F5              - åˆ é™¤æ–‡ä»¶
        F6              - é‡å‘½å
        F7              - ä¿®æ”¹æƒé™
        F8              - æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯
        Delete          - åˆ é™¤é€‰ä¸­
        Backspace       - è¿”å›ä¸Šçº§
        
        å…¶ä»–ï¼š
        F1              - å¸®åŠ©
        Ctrl+Q          - é€€å‡ºç¨‹åº
        """
        
        self.show_message_dialog("å¿«æ·é”®", shortcuts_text)
    
    def show_about(self):
        """æ˜¾ç¤ºå…³äºä¿¡æ¯"""
        about_text = f"""
        OpenFM å¢å¼ºç‰ˆ v{self.VERSION}
        
        ä¸€ä¸ªå¼ºå¤§çš„å¹¶è¡Œåº”ç”¨æ–‡ä»¶ç®¡ç†å™¨
        
        ä¸»è¦ç‰¹æ€§ï¼š
        Â· å·¦å³é¢æ¿ç‹¬ç«‹åº”ç”¨è¿è¡Œ
        Â· æ”¯æŒå¤šç§åº”ç”¨ç±»å‹
        Â· åµŒå…¥å¼ç»ˆç«¯å’Œç¼–è¾‘å™¨
        Â· æ™ºèƒ½æ–‡ä»¶å…³è”
        Â· å¯æ‰©å±•çš„åº”ç”¨ç³»ç»Ÿ
        
        ä½œè€…ï¼šOpenFMå¼€å‘å›¢é˜Ÿ
        è®¸å¯è¯ï¼šGPL v3
        
        æ„Ÿè°¢ä½¿ç”¨OpenFMï¼
        """
        
        self.show_message_dialog("å…³äºOpenFM", about_text)
    
    def show_message_dialog(self, title, message):
        """æ˜¾ç¤ºæ¶ˆæ¯å¯¹è¯æ¡†"""
        dialog = tk.Toplevel(self.root)
        dialog.title(title)
        dialog.geometry("600x400")
        dialog.transient(self.root)
        
        text_frame = ttk.Frame(dialog)
        text_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        text_widget = tk.Text(text_frame, wrap=tk.WORD)
        scrollbar = ttk.Scrollbar(text_frame, orient=tk.VERTICAL, command=text_widget.yview)
        text_widget.configure(yscrollcommand=scrollbar.set)
        
        text_widget.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        text_widget.insert(tk.END, message)
        text_widget.configure(state=tk.DISABLED)
        
        close_btn = ttk.Button(dialog, text="å…³é—­", command=dialog.destroy)
        close_btn.pack(pady=10)
    
    def on_closing(self):
        """çª—å£å…³é—­äº‹ä»¶"""
        # åœæ­¢æ‰€æœ‰åº”ç”¨è¿›ç¨‹
        if self.left_app_process:
            try:
                self.left_app_process.terminate()
            except:
                pass
        
        if self.right_app_process:
            try:
                self.right_app_process.terminate()
            except:
                pass
        
        self.root.destroy()


def main():
    """ä¸»å‡½æ•°"""
    root = tk.Tk()
    app = OpenFMEnhanced(root)
    root.mainloop()


if __name__ == "__main__":
    main()
EOF
    
    print_status "å¢å¼ºç‰ˆå›¾å½¢ç•Œé¢åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºå¢å¼ºç‰ˆå¯åŠ¨è„šæœ¬
create_enhanced_launcher() {
    print_info "åˆ›å»ºå¢å¼ºç‰ˆå¯åŠ¨è„šæœ¬..."
    
    cat > "$INSTALL_DIR/fm-enhanced" << 'EOF'
#!/bin/bash
# OpenFM (FM) å¯åŠ¨è„šæœ¬ - å¢å¼ºç‰ˆ

APP_DIR="/opt/openfm"
PYTHON_SCRIPT="$APP_DIR/app/fm_enhanced.py"

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    echo "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    
    # æ£€æŸ¥Python3
    if ! command -v python3 &> /dev/null; then
        echo "é”™è¯¯: éœ€è¦ Python3"
        echo "è¯·å®‰è£…: sudo apt install python3 æˆ– sudo yum install python3"
        return 1
    fi
    
    # æ£€æŸ¥tkinter
    if ! python3 -c "import tkinter" 2>/dev/null; then
        echo "é”™è¯¯: Python tkinteræ¨¡å—ä¸å¯ç”¨"
        if command -v apt &> /dev/null; then
            echo "è¯·å®‰è£…: sudo apt install python3-tk"
        elif command -v yum &> /dev/null; then
            echo "è¯·å®‰è£…: sudo yum install python3-tkinter"
        else
            echo "è¯·å®‰è£…Python tkinteråŒ…"
        fi
        return 1
    fi
    
    echo "ä¾èµ–æ£€æŸ¥é€šè¿‡"
    return 0
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    echo "ç”¨æ³•: fm-enhanced [é€‰é¡¹]"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -h, --help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo "  -v, --version  æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo "  --left PATH    è®¾ç½®å·¦ä¾§é¢æ¿åˆå§‹è·¯å¾„"
    echo "  --right PATH   è®¾ç½®å³ä¾§é¢æ¿åˆå§‹è·¯å¾„"
    echo "  --mode MODE    è®¾ç½®å¯åŠ¨æ¨¡å¼ (file_manager, terminal, editor, viewer)"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  fm-enhanced"
    echo "  fm-enhanced --left ~/Documents --right /tmp --mode terminal"
    echo ""
    echo "å¯åŠ¨æ¨¡å¼:"
    echo "  file_manager   - åŒæ–‡ä»¶ç®¡ç†å™¨æ¨¡å¼ (é»˜è®¤)"
    echo "  terminal       - å·¦æ–‡ä»¶ç®¡ç†å™¨ï¼Œå³ç»ˆç«¯"
    echo "  editor         - å·¦æ–‡ä»¶ç®¡ç†å™¨ï¼Œå³æ–‡æœ¬ç¼–è¾‘å™¨"
    echo "  viewer         - å·¦æ–‡ä»¶ç®¡ç†å™¨ï¼Œå³å›¾ç‰‡æŸ¥çœ‹å™¨"
}

# è§£æå‘½ä»¤è¡Œå‚æ•°
parse_args() {
    LEFT_PATH=""
    RIGHT_PATH=""
    MODE=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                echo "OpenFM Enhanced v2.0.0"
                exit 0
                ;;
            --left)
                LEFT_PATH="$2"
                export OPENFM_LEFT_PATH="$2"
                shift 2
                ;;
            --right)
                RIGHT_PATH="$2"
                export OPENFM_RIGHT_PATH="$2"
                shift 2
                ;;
            --mode)
                MODE="$2"
                export OPENFM_START_MODE="$2"
                shift 2
                ;;
            *)
                echo "æœªçŸ¥é€‰é¡¹: $1"
                show_help
                exit 1
                ;;
        esac
    done
    
    # è®¾ç½®é»˜è®¤å€¼
    if [ -n "$LEFT_PATH" ]; then
        echo "å·¦é¢æ¿è·¯å¾„: $LEFT_PATH"
    fi
    if [ -n "$RIGHT_PATH" ]; then
        echo "å³é¢æ¿è·¯å¾„: $RIGHT_PATH"
    fi
    if [ -n "$MODE" ]; then
        echo "å¯åŠ¨æ¨¡å¼: $MODE"
    fi
}

# ä¸»å‡½æ•°
main() {
    parse_args "$@"
    
    if ! check_dependencies; then
        exit 1
    fi
    
    cd "$APP_DIR" || exit 1
    
    # è¿è¡ŒPythonç¨‹åº
    exec python3 "$PYTHON_SCRIPT"
}

main "$@"
EOF
    
    chmod +x "$INSTALL_DIR/fm-enhanced"
    print_status "å¢å¼ºç‰ˆå¯åŠ¨è„šæœ¬åˆ›å»ºå®Œæˆ"
}

# åˆ›å»ºæ¡Œé¢å¯åŠ¨å™¨ï¼ˆå¢å¼ºç‰ˆï¼‰
create_enhanced_desktop_launcher() {
    print_info "åˆ›å»ºå¢å¼ºç‰ˆæ¡Œé¢å¯åŠ¨å™¨..."
    
    # åˆ›å»ºå›¾æ ‡
    cat > "$INSTALL_DIR/icons/openfm_enhanced.svg" << 'EOF'
<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48">
    <!-- å·¦é¢æ¿ -->
    <rect x="2" y="2" width="20" height="44" rx="3" fill="#4A90E2" opacity="0.9"/>
    <!-- å³é¢æ¿ -->
    <rect x="26" y="2" width="20" height="44" rx="3" fill="#7B68EE" opacity="0.9"/>
    
    <!-- å·¦é¢æ¿å›¾æ ‡ï¼šæ–‡ä»¶ç®¡ç†å™¨ -->
    <rect x="6" y="8" width="12" height="8" rx="1" fill="#FFFFFF"/>
    <rect x="6" y="20" width="8" height="8" rx="1" fill="#FFFFFF"/>
    <rect x="6" y="32" width="10" height="8" rx="1" fill="#FFFFFF"/>
    
    <!-- å³é¢æ¿å›¾æ ‡ï¼šç»ˆç«¯ -->
    <rect x="30" y="8" width="12" height="4" rx="1" fill="#00FF00"/>
    <rect x="30" y="16" width="12" height="4" rx="1" fill="#00FF00"/>
    <rect x="30" y="24" width="12" height="4" rx="1" fill="#00FF00"/>
    <rect x="30" y="32" width="8" height="4" rx="1" fill="#00FF00"/>
    <rect x="42" y="32" width="4" height="4" rx="1" fill="#FF0000"/>
    
    <!-- è¿æ¥çº¿ -->
    <line x1="22" y1="24" x2="26" y2="24" stroke="#FF6B6B" stroke-width="2"/>
    <circle cx="24" cy="24" r="3" fill="#FF6B6B"/>
    
    <!-- åº”ç”¨æ ‡ç­¾ -->
    <text x="12" y="48" font-size="4" text-anchor="middle" fill="#333">æ–‡ä»¶</text>
    <text x="36" y="48" font-size="4" text-anchor="middle" fill="#333">ç»ˆç«¯</text>
</svg>
EOF
    
    # åˆ›å»ºPNGå›¾æ ‡
    if command -v convert &> /dev/null; then
        convert "$INSTALL_DIR/icons/openfm_enhanced.svg" "$INSTALL_DIR/icons/openfm_enhanced.png"
    fi
    
    # åˆ›å»ºæ¡Œé¢é…ç½®æ–‡ä»¶
    cat > "$INSTALL_DIR/openfm-enhanced.desktop" << 'EOF'
[Desktop Entry]
Name=OpenFM Enhanced
Name[zh_CN]=OpenFM å¢å¼ºç‰ˆ
Comment=Parallel Application File Manager with Terminal and Viewer integration
Comment[zh_CN]=å¹¶è¡Œåº”ç”¨æ–‡ä»¶ç®¡ç†å™¨ï¼Œé›†æˆç»ˆç«¯å’ŒæŸ¥çœ‹å™¨
Exec=fm-enhanced
Icon=/opt/openfm/icons/openfm_enhanced.svg
Terminal=false
Type=Application
Categories=System;FileTools;Utility;Development;
StartupNotify=true
Keywords=file;manager;explorer;terminal;editor;viewer;parallel;åŒé¢æ¿;æ–‡ä»¶ç®¡ç†;ç»ˆç«¯;ç¼–è¾‘å™¨;å¹¶è¡Œ
Actions=FileManager;TerminalEditor;Custom;

[Desktop Action FileManager]
Name=File Manager Mode
Name[zh_CN]=æ–‡ä»¶ç®¡ç†å™¨æ¨¡å¼
Exec=fm-enhanced --mode file_manager

[Desktop Action TerminalEditor]
Name=Terminal + Editor
Name[zh_CN]=ç»ˆç«¯ + ç¼–è¾‘å™¨
Exec=fm-enhanced --mode terminal

[Desktop Action Custom]
Name=Custom Configuration
Name[zh_CN]=è‡ªå®šä¹‰é…ç½®
Exec=fm-enhanced --left ~/Documents --right /tmp --mode terminal
EOF
    
    # å®‰è£…åˆ°ç³»ç»Ÿç›®å½•
    if [ -d "/usr/share/applications" ]; then
        sudo cp "$INSTALL_DIR/openfm-enhanced.desktop" "/usr/share/applications/"
        print_status "å¢å¼ºç‰ˆæ¡Œé¢å¯åŠ¨å™¨å®‰è£…åˆ°ç³»ç»Ÿç›®å½•"
    fi
    
    # å®‰è£…åˆ°ç”¨æˆ·ç›®å½•
    if [ -d "$HOME/.local/share/applications" ]; then
        cp "$INSTALL_DIR/openfm-enhanced.desktop" "$HOME/.local/share/applications/"
        print_status "å¢å¼ºç‰ˆæ¡Œé¢å¯åŠ¨å™¨å®‰è£…åˆ°ç”¨æˆ·ç›®å½•"
    fi
    
    # å¤åˆ¶åˆ°æ¡Œé¢
    if [ -d "$HOME/Desktop" ]; then
        cp "$INSTALL_DIR/openfm-enhanced.desktop" "$HOME/Desktop/"
        chmod +x "$HOME/Desktop/openfm-enhanced.desktop"
        print_status "å¢å¼ºç‰ˆæ¡Œé¢å¿«æ·æ–¹å¼å·²åˆ›å»º"
    fi
}

# åˆ›å»ºç³»ç»Ÿç¬¦å·é“¾æ¥
create_symlinks() {
    print_section "åˆ›å»ºç³»ç»Ÿç¬¦å·é“¾æ¥"
    
    # åˆ›å»ºå¢å¼ºç‰ˆç¬¦å·é“¾æ¥
    if [ -w "$BIN_DIR" ] || sudo test -w "$BIN_DIR"; then
        sudo ln -sf "$INSTALL_DIR/fm-enhanced" "$BIN_DIR/fm-enhanced"
        print_status "å¢å¼ºç‰ˆç¬¦å·é“¾æ¥åˆ›å»º: $BIN_DIR/fm-enhanced"
        
        # åˆ›å»ºä¸»å‘½ä»¤é“¾æ¥
        sudo ln -sf "$INSTALL_DIR/fm-enhanced" "$BIN_DIR/openfm"
        print_status "ä¸»å‘½ä»¤é“¾æ¥åˆ›å»º: $BIN_DIR/openfm"
        
        # åˆ›å»ºå¿«æ·å‘½ä»¤
        sudo ln -sf "$INSTALL_DIR/fm-enhanced" "$BIN_DIR/fm"
        print_status "å¿«æ·å‘½ä»¤åˆ›å»º: $BIN_DIR/fm"
    else
        print_warning "æ— æ³•åˆ›å»ºç³»ç»Ÿç¬¦å·é“¾æ¥ï¼Œè¯·æ‰‹åŠ¨åˆ›å»º:"
        print_warning "  sudo ln -s $INSTALL_DIR/fm-enhanced $BIN_DIR/fm-enhanced"
        print_warning "  sudo ln -s $INSTALL_DIR/fm-enhanced $BIN_DIR/openfm"
        print_warning "  sudo ln -s $INSTALL_DIR/fm-enhanced $BIN_DIR/fm"
    fi
}

# è®¾ç½®æ–‡ä»¶æƒé™
set_permissions() {
    print_section "è®¾ç½®æ–‡ä»¶æƒé™"
    
    # è®¾ç½®å¯æ‰§è¡Œæƒé™
    chmod +x "$INSTALL_DIR/fm-enhanced"
    chmod +x "$INSTALL_DIR/app/fm_enhanced.py"
    chmod 644 "$INSTALL_DIR/config/apps.json"
    
    # è®¾ç½®ç›®å½•æƒé™
    chmod 755 "$INSTALL_DIR"
    chmod 755 "$INSTALL_DIR/app"
    chmod 755 "$INSTALL_DIR/data"
    chmod 755 "$INSTALL_DIR/icons"
    chmod 755 "$INSTALL_DIR/config"
    chmod 755 "$INSTALL_DIR/plugins"
    chmod 755 "$INSTALL_DIR/apps"
    
    print_status "æ–‡ä»¶æƒé™è®¾ç½®å®Œæˆ"
}

# æ˜¾ç¤ºå®‰è£…å®Œæˆä¿¡æ¯
show_completion_message() {
    clear
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "    ğŸš€ OpenFM å¢å¼ºç‰ˆ - å®‰è£…å®Œæˆï¼"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "ğŸ‰ æ­å–œï¼OpenFM å¢å¼ºç‰ˆå·²æˆåŠŸå®‰è£…åˆ°æ‚¨çš„ç³»ç»Ÿã€‚"
    echo ""
    echo "ğŸ“ å®‰è£…ç›®å½•: $INSTALL_DIR"
    echo ""
    echo "ğŸš€ å¯åŠ¨æ–¹å¼:"
    echo "   å¢å¼ºç‰ˆ:    fm-enhanced æˆ– openfm æˆ– fm"
    echo "   æ¡Œé¢å›¾æ ‡:  åœ¨åº”ç”¨ç¨‹åºèœå•ä¸­æŸ¥æ‰¾ 'OpenFM Enhanced'"
    echo ""
    echo "ğŸŒŸ æ ¸å¿ƒç‰¹æ€§:"
    echo "   Â· å¹¶è¡Œåº”ç”¨æ¨¡å¼ - å·¦å³é¢æ¿è¿è¡Œä¸åŒåº”ç”¨"
    echo "   Â· åµŒå…¥å¼ç»ˆç«¯ - å¯ç›´æ¥åœ¨ç•Œé¢ä¸­æ“ä½œå‘½ä»¤"
    echo "   Â· æ™ºèƒ½åº”ç”¨åˆ‡æ¢ - ç‚¹å‡»â˜°æŒ‰é’®é€‰æ‹©åº”ç”¨"
    echo "   Â· è°ƒç”¨ç³»ç»Ÿç»ˆç«¯ - ä¸€é”®æ‰“å¼€çœŸæ­£çš„ç»ˆç«¯"
    echo ""
    echo "ğŸ¯ åº”ç”¨ç±»å‹:"
    echo "   ğŸ“ æ–‡ä»¶ç®¡ç†å™¨  âŒ¨ï¸ ç»ˆç«¯  ğŸ“ æ–‡æœ¬ç¼–è¾‘å™¨"
    echo "   ğŸ–¼ï¸ å›¾ç‰‡æŸ¥çœ‹å™¨  ğŸ“„ PDFæŸ¥çœ‹å™¨  ğŸ¬ åª’ä½“æ’­æ”¾å™¨"
    echo "   ğŸŒ ç½‘é¡µæµè§ˆå™¨  ğŸ’» å¼€å‘å·¥å…·"
    echo ""
    echo "âŒ¨ï¸  ä¸»è¦å¿«æ·é”®:"
    echo "   Ctrl+M        - æ˜¾ç¤ºåº”ç”¨é€‰æ‹©å™¨"
    echo "   Ctrl+1        - æ–‡ä»¶ç®¡ç†å™¨æ¨¡å¼"
    echo "   Ctrl+2        - ç»ˆç«¯æ¨¡å¼"
    echo "   Ctrl+3        - ç¼–è¾‘å™¨æ¨¡å¼"
    echo "   F11           - å…¨å±åˆ‡æ¢"
    echo "   Alt+Left/Right - åˆ‡æ¢æ´»åŠ¨é¢æ¿"
    echo ""
    echo "ğŸ”§ é…ç½®ç¤ºä¾‹:"
    echo "   fm-enhanced --left ~/Documents --right /tmp --mode terminal"
    echo "   fm-enhanced --mode editor"
    echo ""
    echo "â“ è·å–å¸®åŠ©:"
    echo "   fm-enhanced --help"
    echo "   åº”ç”¨ç¨‹åºå†…æŒ‰ F1 é”®"
    echo ""
    echo "ğŸ—‘ï¸  å¸è½½æ–¹æ³•:"
    echo "   sudo rm -rf $INSTALL_DIR"
    echo "   sudo rm -f $BIN_DIR/fm-enhanced"
    echo "   sudo rm -f $BIN_DIR/openfm"
    echo "   sudo rm -f $BIN_DIR/fm"
    echo "   rm -f ~/.local/share/applications/openfm-enhanced.desktop"
    echo "   rm -f ~/Desktop/openfm-enhanced.desktop"
    echo ""
    echo "ğŸ’¡ ä½¿ç”¨å»ºè®®:"
    echo "   1. å·¦é¢æ¿è®¾ä¸ºæ–‡ä»¶ç®¡ç†å™¨ï¼Œå³é¢æ¿è®¾ä¸ºç»ˆç«¯"
    echo "   2. åœ¨å·¦é¢æ¿æŸ¥çœ‹æ–‡ä»¶ï¼Œåœ¨å³é¢æ¿æ‰§è¡Œå‘½ä»¤"
    echo "   3. ä½¿ç”¨'è°ƒç”¨ç³»ç»Ÿç»ˆç«¯'æŒ‰é’®æ‰“å¼€å®Œæ•´ç»ˆç«¯"
    echo "   4. å³é”®æ–‡ä»¶é€‰æ‹©'åœ¨ç»ˆç«¯ä¸­æ‰“å¼€'å¿«é€Ÿå®šä½"
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    # æµ‹è¯•å‘½ä»¤æ˜¯å¦å¯ç”¨
    if command -v fm-enhanced &> /dev/null; then
        echo "âœ… å‘½ä»¤æµ‹è¯•: 'fm-enhanced' å¯ç”¨"
    else
        echo "âš ï¸  å‘½ä»¤æµ‹è¯•: 'fm-enhanced' å¯èƒ½ä¸å¯ç”¨ï¼Œè¯·é‡å¯ç»ˆç«¯"
    fi
    
    if command -v openfm &> /dev/null; then
        echo "âœ… å‘½ä»¤æµ‹è¯•: 'openfm' å¯ç”¨"
    else
        echo "âš ï¸  å‘½ä»¤æµ‹è¯•: 'openfm' å¯èƒ½ä¸å¯ç”¨ï¼Œè¯·é‡å¯ç»ˆç«¯"
    fi
    
    if command -v fm &> /dev/null; then
        echo "âœ… å‘½ä»¤æµ‹è¯•: 'fm' å¯ç”¨"
    else
        echo "âš ï¸  å‘½ä»¤æµ‹è¯•: 'fm' å¯èƒ½ä¸å¯ç”¨ï¼Œè¯·é‡å¯ç»ˆç«¯"
    fi
    
    echo ""
    echo "ğŸš€ ç°åœ¨æ‚¨å¯ä»¥å¼€å§‹ä½“éªŒå¼ºå¤§çš„å¹¶è¡Œåº”ç”¨æ–‡ä»¶ç®¡ç†å™¨äº†ï¼"
    echo ""
}

# ä¸»å®‰è£…å‡½æ•°
main_install() {
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "   ğŸš€ OpenFM å¢å¼ºç‰ˆå®‰è£…ç¨‹åº"
    echo "   ï¼ˆå¸¦å¹¶è¡Œåº”ç”¨åŠŸèƒ½ï¼‰"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    check_permissions
    check_dependencies
    clean_old_version
    create_directories
    create_apps_config
    create_enhanced_gui_version
    create_enhanced_launcher
    create_enhanced_desktop_launcher
    create_symlinks
    set_permissions
    show_completion_message
}

# è¿è¡Œå®‰è£…
main_install